<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#05060F">
  <title>Phonétique</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
  <style>
/* ============================================================
   PHONÉTIQUE APP — STYLES
   Electric blue/purple dark mode
   ============================================================ */

@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,700;1,9..40,400&display=swap');

/* ── CSS VARIABLES ─────────────────────────────────────────── */
:root {
  --bg: #05060F;
  --bg2: #0D0F1E;
  --bg3: #131629;
  --surface: #1A1D35;
  --surface2: #222640;
  --border: rgba(99, 102, 241, 0.18);
  --border-bright: rgba(99, 102, 241, 0.4);
  --text: #E8EAF8;
  --text2: #9BA3C4;
  --text3: #5A6080;
  --blue: #4F8EF7;
  --purple: #8B5CF6;
  --electric: #60A5FA;
  --neon-blue: #3B82F6;
  --neon-purple: #7C3AED;
  --glow-blue: rgba(79, 142, 247, 0.3);
  --glow-purple: rgba(139, 92, 246, 0.3);
  --font-display: 'Space Mono', monospace;
  --font-body: 'DM Sans', sans-serif;
  --radius: 16px;
  --radius-sm: 10px;
  --radius-lg: 24px;
}

[data-theme="light"] {
  --bg: #F0F2FF;
  --bg2: #E8EAFE;
  --bg3: #DDE0FC;
  --surface: #FFFFFF;
  --surface2: #F5F6FF;
  --border: rgba(99, 102, 241, 0.15);
  --border-bright: rgba(99, 102, 241, 0.35);
  --text: #1A1D35;
  --text2: #4A5080;
  --text3: #8A93B4;
  --glow-blue: rgba(79, 142, 247, 0.15);
  --glow-purple: rgba(139, 92, 246, 0.15);
}

/* ── RESET & BASE ──────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 16px;
  -webkit-font-smoothing: antialiased;
  height: 100%;
  overflow: hidden;
}

body {
  height: 100%;
  overflow: hidden;
  background: var(--bg);
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: 
    radial-gradient(ellipse 600px 400px at 20% 20%, rgba(99,60,220,0.08) 0%, transparent 60%),
    radial-gradient(ellipse 500px 400px at 80% 80%, rgba(37,99,235,0.07) 0%, transparent 60%),
    radial-gradient(ellipse 400px 300px at 60% 10%, rgba(139,92,246,0.05) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

#app {
  position: relative;
  z-index: 1;
  height: 100%;
  display: flex;
  flex-direction: column;
  max-width: 480px;
  margin: 0 auto;
}

#main {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 0 32px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

#main::-webkit-scrollbar { width: 4px; }
#main::-webkit-scrollbar-track { background: transparent; }
#main::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 2px; }

/* ── TRANSITIONS ────────────────────────────────────────────── */
.screen-exit {
  animation: screenExit 0.15s ease-in forwards;
}
.screen-enter {
  animation: screenEnter 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

@keyframes screenExit {
  from { opacity: 1; transform: translateX(0); }
  to   { opacity: 0; transform: translateX(-20px); }
}

@keyframes screenEnter {
  from { opacity: 0; transform: translateX(24px); }
  to   { opacity: 1; transform: translateX(0); }
}

/* ── SHARED HEADER ──────────────────────────────────────────── */
.screen-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 20px 12px;
  position: sticky;
  top: 0;
  z-index: 10;
  background: linear-gradient(180deg, var(--bg) 80%, transparent 100%);
}

.screen-title {
  font-family: var(--font-display);
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  flex: 1;
  text-align: right;
  color: var(--text2);
}

.home-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.2s;
  line-height: 1;
}
.home-btn:hover { border-color: var(--border-bright); background: var(--surface2); }

.logo-ph {
  font-family: var(--font-display);
  font-size: 15px;
  font-weight: 700;
  color: var(--electric);
  letter-spacing: -0.02em;
}
.logo-onetique {
  font-family: var(--font-display);
  font-size: 15px;
  font-weight: 700;
  color: var(--purple);
  letter-spacing: -0.02em;
}

.back-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: var(--text2);
  transition: all 0.2s;
}
.back-btn:hover { border-color: var(--border-bright); color: var(--text); }
.back-btn svg { width: 18px; height: 18px; }

.icon-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: var(--text2);
  transition: all 0.2s;
}
.icon-btn:hover { border-color: var(--border-bright); color: var(--text); background: var(--surface2); }
.icon-btn svg { width: 16px; height: 16px; }

/* ── HOME ───────────────────────────────────────────────────── */
.home-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  padding: 24px 20px 8px;
}

.app-logo {
  display: flex;
  flex-direction: column;
}

.app-logo .logo-ph {
  font-size: 28px;
  background: linear-gradient(135deg, #60A5FA 0%, #8B5CF6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.app-logo .logo-onetique {
  font-size: 28px;
  background: linear-gradient(135deg, #60A5FA 0%, #8B5CF6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  display: inline;
}

.app-logo > *:first-child {
  display: flex;
  align-items: baseline;
  gap: 0;
}

.logo-tagline {
  font-size: 12px;
  color: var(--text3);
  margin-top: 4px;
  font-weight: 400;
  letter-spacing: 0.02em;
}

.header-actions {
  display: flex;
  gap: 8px;
  margin-top: 4px;
}

.category-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  padding: 16px 20px 24px;
}

.category-tile {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px 16px 22px;
  text-align: left;
  cursor: pointer;
  overflow: hidden;
  transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-height: 130px;
}

.category-tile:hover,
.category-tile:active {
  transform: translateY(-3px) scale(1.02);
  border-color: var(--cat-accent);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 20px color-mix(in srgb, var(--cat-color) 30%, transparent);
}

.cat-icon {
  font-family: var(--font-display);
  font-size: 24px;
  color: var(--cat-accent);
  line-height: 1;
  margin-bottom: 2px;
}

.cat-label {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  line-height: 1.2;
}

.cat-desc {
  font-size: 11px;
  color: var(--text3);
  line-height: 1.3;
}

.cat-glow {
  position: absolute;
  bottom: -20px;
  right: -20px;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: radial-gradient(circle, var(--cat-color) 0%, transparent 70%);
  opacity: 0.25;
  pointer-events: none;
  transition: opacity 0.3s;
}

.category-tile:hover .cat-glow { opacity: 0.45; }

/* ── PHONEME GRID ────────────────────────────────────────────── */
.phoneme-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  padding: 8px 20px 24px;
}

.phoneme-tile {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 16px;
  text-align: left;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  display: flex;
  flex-direction: column;
  gap: 4px;
  position: relative;
  overflow: hidden;
}

.phoneme-tile:hover,
.phoneme-tile:active {
  transform: translateY(-2px);
  border-color: var(--cat-accent);
  box-shadow: 0 6px 24px rgba(0,0,0,0.25);
}

.phoneme-ipa {
  font-family: var(--font-display);
  font-size: 22px;
  color: var(--cat-accent);
  font-weight: 700;
  letter-spacing: -0.02em;
}

.phoneme-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}

.phoneme-examples {
  font-size: 11px;
  color: var(--text3);
}

.phoneme-score {
  font-family: var(--font-display);
  font-size: 13px;
  font-weight: 700;
  margin-top: 8px;
}

/* ── PHONEME HERO ────────────────────────────────────────────── */
.phoneme-hero {
  padding: 16px 20px 24px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.phoneme-hero-ipa {
  font-family: var(--font-display);
  font-size: 52px;
  font-weight: 700;
  letter-spacing: -0.03em;
  line-height: 1;
  text-shadow: 0 0 40px currentColor;
}

.phoneme-hero-label {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.phoneme-hero-desc {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.5;
  max-width: 300px;
  text-align: center;
}

.phoneme-hero-graphies {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
}

.graphie-tag {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 3px 10px;
  font-family: var(--font-display);
  font-size: 12px;
  color: var(--text2);
}

/* ── MODE GRID ───────────────────────────────────────────────── */
.mode-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  padding: 4px 20px 24px;
}

.mode-tile {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px 16px 20px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 8px;
  transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  position: relative;
  overflow: hidden;
  min-height: 120px;
}

.mode-tile:hover,
.mode-tile:active {
  transform: translateY(-3px);
  box-shadow: 0 8px 28px rgba(0,0,0,0.3);
}

.mode-practice { --mode-color: #4F8EF7; }
.mode-read     { --mode-color: #8B5CF6; }
.mode-compare  { --mode-color: #06B6D4; }
.mode-test     { --mode-color: #10B981; }

.mode-tile:hover { border-color: var(--mode-color); }
.mode-tile::after {
  content: '';
  position: absolute;
  bottom: -30px; right: -30px;
  width: 90px; height: 90px;
  border-radius: 50%;
  background: radial-gradient(circle, var(--mode-color) 0%, transparent 70%);
  opacity: 0.15;
  transition: opacity 0.3s;
}
.mode-tile:hover::after { opacity: 0.3; }

.mode-icon {
  color: var(--mode-color);
  width: 32px; height: 32px;
}
.mode-icon svg { width: 28px; height: 28px; }

.mode-label {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
}

.mode-sub {
  font-size: 11px;
  color: var(--text3);
  line-height: 1.3;
}

/* ── PRACTICE MODE ───────────────────────────────────────────── */
.practice-container {
  padding: 8px 20px 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.practice-sound-card {
  background: linear-gradient(135deg, 
    color-mix(in srgb, var(--cat-color) 15%, var(--surface)) 0%,
    var(--surface) 100%);
  border: 1px solid color-mix(in srgb, var(--cat-color) 40%, var(--border));
  border-radius: var(--radius-lg);
  padding: 28px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  text-align: center;
}

.practice-ipa {
  font-family: var(--font-display);
  font-size: 48px;
  font-weight: 700;
  color: var(--cat-accent);
  text-shadow: 0 0 30px var(--cat-accent);
  line-height: 1;
}

.practice-word {
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
  margin-top: 4px;
}

.practice-word-ipa {
  font-family: var(--font-display);
  font-size: 14px;
  color: var(--text3);
}

.listen-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: color-mix(in srgb, var(--cat-color) 20%, var(--surface2));
  border: 1px solid color-mix(in srgb, var(--cat-color) 40%, transparent);
  border-radius: 100px;
  padding: 10px 24px;
  color: var(--cat-accent);
  font-family: var(--font-body);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.2s;
}
.listen-btn:hover { background: color-mix(in srgb, var(--cat-color) 30%, var(--surface2)); transform: scale(1.03); }
.listen-btn svg { width: 18px; height: 18px; }

/* ── WORD CAROUSEL ───────────────────────────────────────── */
.word-carousel {
  display: flex;
  align-items: center;
  gap: 0;
  width: 100%;
  min-height: 90px;
  position: relative;
}

.carousel-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  overflow: hidden;
}

.carousel-word-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  transition: opacity 0.15s ease;
}

.carousel-word-wrap.slide-exit-left  { animation: slideExitLeft  0.15s ease forwards; }
.carousel-word-wrap.slide-exit-right { animation: slideExitRight 0.15s ease forwards; }
.carousel-word-wrap.slide-enter-right { animation: slideEnterRight 0.25s cubic-bezier(0.25,0.46,0.45,0.94) forwards; }
.carousel-word-wrap.slide-enter-left  { animation: slideEnterLeft  0.25s cubic-bezier(0.25,0.46,0.45,0.94) forwards; }

@keyframes slideExitLeft  { to { opacity: 0; transform: translateX(-28px); } }
@keyframes slideExitRight { to { opacity: 0; transform: translateX(28px); } }
@keyframes slideEnterRight { from { opacity: 0; transform: translateX(28px); } to { opacity: 1; transform: translateX(0); } }
@keyframes slideEnterLeft  { from { opacity: 0; transform: translateX(-28px); } to { opacity: 1; transform: translateX(0); } }

.carousel-arrow {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 12px 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.7;
  transition: opacity 0.2s, transform 0.15s;
  flex-shrink: 0;
}
.carousel-arrow:hover  { opacity: 1; }
.carousel-arrow:active { transform: scale(0.88); }
.carousel-arrow svg { width: 32px; height: 32px; filter: drop-shadow(0 0 6px currentColor); }

.carousel-dots {
  display: flex;
  gap: 6px;
  align-items: center;
}
.carousel-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--surface2);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
}
.carousel-dot.active {
  background: var(--cat-accent);
  border-color: var(--cat-accent);
  width: 18px;
  border-radius: 3px;
  box-shadow: 0 0 8px var(--cat-accent);
}

.practice-tips {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.tip-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text3);
}

.tip-text {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.5;
}

.tip-graphies {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

/* ── RECORD BUTTON ───────────────────────────────────────────── */
.record-section, .read-record-section, .test-record-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.record-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
}

.record-btn-inner {
  width: 72px; height: 72px;
  border-radius: 50%;
  background: linear-gradient(135deg, #4F8EF7 0%, #8B5CF6 100%);
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 0 0 rgba(79,142,247,0.4);
  transition: all 0.2s;
  position: relative;
}

.record-btn-inner svg {
  width: 30px; height: 30px;
  color: white;
}

.record-btn:hover .record-btn-inner {
  transform: scale(1.08);
  box-shadow: 0 0 0 8px rgba(79,142,247,0.15);
}

.record-btn.recording-active .record-btn-inner {
  background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
  animation: recordPulse 1.2s infinite;
}

.large-record .record-btn-inner {
  width: 88px; height: 88px;
}
.large-record .record-btn-inner svg {
  width: 36px; height: 36px;
}

@keyframes recordPulse {
  0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
  70% { box-shadow: 0 0 0 16px rgba(239,68,68,0); }
  100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
}

.record-label {
  font-size: 12px;
  color: var(--text3);
  font-weight: 500;
  text-align: center;
}

.record-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.record-btn:disabled .record-btn-inner { animation: none; }

/* ── STATUS & PLAYBACK ───────────────────────────────────────── */
.hidden { display: none !important; }

.recording-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text2);
}

.pulse-dot {
  width: 8px; height: 8px;
  background: #EF4444;
  border-radius: 50%;
  animation: pulseDot 1s infinite;
}

@keyframes pulseDot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.8); }
}

.analyzing-dots {
  display: flex;
  gap: 4px;
}
.analyzing-dots span {
  width: 6px; height: 6px;
  background: var(--blue);
  border-radius: 50%;
  animation: analyzeDot 1.2s infinite;
}
.analyzing-dots span:nth-child(2) { animation-delay: 0.2s; }
.analyzing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes analyzeDot {
  0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

.playback-area {
  display: flex;
  align-items: center;
  gap: 12px;
}

.playback-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 100px;
  padding: 9px 20px;
  color: var(--text2);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.playback-btn:hover { border-color: var(--border-bright); color: var(--text); }
.playback-btn svg { width: 14px; height: 14px; }

/* ── SCORE DISPLAY ───────────────────────────────────────────── */
.score-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  width: 100%;
}

.score-display {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.score-ring {
  position: relative;
  width: 110px; height: 110px;
}
.score-ring svg { width: 100%; height: 100%; }
.score-ring circle:last-child {
  transition: stroke-dasharray 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.score-number {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
  line-height: 1;
}
.score-pct-sym {
  font-size: 16px;
}

.score-feedback {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  text-align: center;
}

.score-sub-row {
  display: flex;
  gap: 16px;
  justify-content: center;
}
.score-sub {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 7px 16px;
}
.score-sub-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text3);
  font-weight: 700;
}
.score-sub-val {
  font-family: var(--font-display);
  font-size: 17px;
  font-weight: 700;
}

.score-detail {
  font-size: 12px;
  color: var(--text3);
}

.score-next-hint {
  font-size: 13px;
  color: var(--text2);
  font-weight: 500;
}

.retry-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 100px;
  padding: 10px 24px;
  color: var(--text2);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.retry-btn:hover { border-color: var(--border-bright); color: var(--text); }
.retry-btn svg { width: 14px; height: 14px; }

.next-btn {
  background: linear-gradient(135deg, #4F8EF7 0%, #8B5CF6 100%);
  border: none;
  border-radius: 100px;
  padding: 12px 28px;
  color: white;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.02em;
}
.next-btn:hover { transform: scale(1.03); box-shadow: 0 4px 20px rgba(79,142,247,0.4); }

.no-azure-msg {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  font-size: 13px;
  color: var(--text3);
  text-align: left;
  max-width: 320px;
}
.no-azure-msg svg { width: 18px; height: 18px; flex-shrink: 0; color: var(--blue); }

/* ── READ MODE ───────────────────────────────────────────────── */
.read-container {
  padding: 8px 20px 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.passage-dots {
  display: flex;
  gap: 8px;
  justify-content: center;
}

.passage-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--surface2);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
}
.passage-dot.active {
  background: var(--blue);
  border-color: var(--blue);
  width: 24px;
  border-radius: 4px;
}

.passage-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 22px;
}

.passage-text {
  font-size: 15px;
  line-height: 1.8;
  color: var(--text);
}

.passage-text mark {
  background: color-mix(in srgb, var(--cat-accent) 25%, transparent);
  color: var(--cat-accent);
  border-radius: 3px;
  padding: 0 1px;
}

.passage-actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
  justify-content: flex-end;
}

.passage-listen-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  width: 40px; height: 40px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: var(--blue);
  transition: all 0.2s;
}
.passage-listen-btn:hover { border-color: var(--blue); background: color-mix(in srgb, var(--blue) 15%, var(--surface2)); }
.passage-listen-btn svg { width: 18px; height: 18px; }

.generate-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  width: 40px; height: 40px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: var(--purple);
  transition: all 0.2s;
}
.generate-btn:hover { border-color: var(--purple); background: color-mix(in srgb, var(--purple) 15%, var(--surface2)); }
.generate-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.generate-btn svg { width: 17px; height: 17px; }

.read-instructions {
  font-size: 13px;
  color: var(--text2);
  text-align: center;
  line-height: 1.5;
}

/* ── COMPARE MODE ────────────────────────────────────────────── */
.compare-container {
  padding: 8px 20px 24px;
}

.compare-main {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: stretch;
}

.compare-vs {
  text-align: center;
  font-family: var(--font-display);
  font-size: 12px;
  color: var(--text3);
  letter-spacing: 0.2em;
  font-weight: 700;
}

.compare-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.compare-card.active-card {
  border-color: color-mix(in srgb, var(--cat-accent) 50%, var(--border));
  background: color-mix(in srgb, var(--cat-color) 8%, var(--surface));
}

.compare-ipa {
  font-family: var(--font-display);
  font-size: 32px;
  font-weight: 700;
  color: var(--cat-accent);
  line-height: 1;
}

.compare-label {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.compare-listen {
  display: flex;
  align-items: center;
  gap: 8px;
  background: color-mix(in srgb, var(--cat-accent) 12%, var(--surface2));
  border: 1px solid color-mix(in srgb, var(--cat-accent) 30%, transparent);
  border-radius: 100px;
  padding: 8px 18px;
  color: var(--cat-accent);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  width: fit-content;
}
.compare-listen:hover { transform: scale(1.03); }
.compare-listen svg { width: 14px; height: 14px; }

.compare-goto {
  background: transparent;
  border: none;
  color: var(--text3);
  font-size: 12px;
  cursor: pointer;
  padding: 4px 0;
  text-align: left;
  transition: color 0.2s;
}
.compare-goto:hover { color: var(--blue); }

.compare-empty {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
  color: var(--text3);
  font-size: 14px;
  line-height: 1.5;
}

/* ── TEST MODE ───────────────────────────────────────────────── */
.test-container {
  padding: 8px 20px 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.test-instructions {
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.test-badge {
  font-family: var(--font-display);
  font-size: 36px;
  font-weight: 700;
  text-shadow: 0 0 24px currentColor;
}

.test-instructions p {
  font-size: 13px;
  color: var(--text2);
}

.test-passage-card {
  background: linear-gradient(135deg,
    color-mix(in srgb, var(--cat-color) 10%, var(--surface)) 0%,
    var(--surface) 100%);
  border: 1px solid color-mix(in srgb, var(--cat-color) 35%, var(--border));
  border-radius: var(--radius-lg);
  padding: 22px;
}

/* ── SCORES SCREEN ───────────────────────────────────────────── */
.scores-container {
  padding: 8px 20px 32px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.scores-category {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.scores-cat-header {
  font-family: var(--font-display);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding-left: 2px;
}

.scores-phoneme-list {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.score-phoneme-row {
  display: grid;
  grid-template-columns: 56px 1fr 80px 44px;
  align-items: center;
  gap: 8px;
  padding: 12px 14px;
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  text-align: left;
  width: 100%;
  transition: background 0.15s;
}
.score-phoneme-row:last-child { border-bottom: none; }
.score-phoneme-row:hover { background: var(--surface2); }

.score-ipa {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 700;
}

.score-label {
  font-size: 12px;
  color: var(--text2);
  font-weight: 500;
}

.score-bar-wrap {
  height: 4px;
  background: var(--bg3);
  border-radius: 2px;
  overflow: hidden;
}

.score-bar {
  display: block;
  height: 100%;
  border-radius: 2px;
  transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.score-pct {
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 700;
  text-align: right;
}

/* ── SETTINGS ────────────────────────────────────────────────── */
.settings-container {
  padding: 8px 20px 32px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.settings-group {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.settings-group-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text3);
  padding: 14px 16px 10px;
  border-bottom: 1px solid var(--border);
}

.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}
.settings-row:last-child { border-bottom: none; }

.settings-label {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: var(--text);
  font-weight: 500;
}
.settings-label svg { width: 16px; height: 16px; color: var(--text3); }

.settings-select {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: 13px;
  cursor: pointer;
}

.settings-field {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.settings-field:last-child { border-bottom: none; }

.field-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--text3);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.field-label svg { width: 14px; height: 14px; }

.settings-input {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: 13px;
  width: 100%;
  transition: border-color 0.2s;
}
.settings-input:focus {
  outline: none;
  border-color: var(--border-bright);
}
.settings-input::placeholder { color: var(--text3); }

.toggle {
  position: relative;
  display: inline-block;
  width: 44px; height: 24px;
}
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  transition: 0.3s;
}
.toggle-slider::before {
  position: absolute;
  content: '';
  height: 16px; width: 16px;
  left: 3px; bottom: 3px;
  background: var(--text3);
  border-radius: 50%;
  transition: 0.3s;
}
.toggle input:checked + .toggle-slider {
  background: linear-gradient(135deg, #4F8EF7 0%, #8B5CF6 100%);
  border-color: transparent;
}
.toggle input:checked + .toggle-slider::before {
  transform: translateX(20px);
  background: white;
}

.reset-scores-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: color-mix(in srgb, #EF4444 10%, var(--surface));
  border: 1px solid color-mix(in srgb, #EF4444 25%, var(--border));
  border-radius: var(--radius-sm);
  padding: 14px;
  color: #F87171;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.reset-scores-btn:hover { background: color-mix(in srgb, #EF4444 20%, var(--surface)); }
.reset-scores-btn svg { width: 16px; height: 16px; }

/* ── LIAISON HIGHLIGHTS ───────────────────────────────────── */
.liaison-cons {
  color: #FBBF24;
  font-weight: 700;
  border-bottom: 2px solid #FBBF24;
  padding-bottom: 1px;
}
.liaison-vowel {
  color: #60A5FA;
  font-weight: 700;
  border-bottom: 2px solid #60A5FA;
  padding-bottom: 1px;
}

/* ── HOME LOGO (single line) ─────────────────────────────── */
.logo-full {
  display: flex;
  align-items: baseline;
  white-space: nowrap;
}
.app-logo .logo-ph {
  font-size: 26px;
}
.app-logo .logo-onetique {
  font-size: 26px;
}

/* ── SCORES TILE (8th tile) ──────────────────────────────── */
.scores-tile {
  background: linear-gradient(135deg,
    color-mix(in srgb, #1E3A5F 60%, var(--surface)) 0%,
    var(--surface) 100%
  ) !important;
}
.scores-tile:hover, .scores-tile:active {
  box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 20px rgba(30,58,95,0.5) !important;
}

/* ── PHRASE LIBRE ────────────────────────────────────────────── */
.libre-container { padding: 8px 20px 32px; display: flex; flex-direction: column; gap: 16px; }
.libre-card { background: linear-gradient(135deg, color-mix(in srgb, var(--cat-color) 15%, var(--surface)) 0%, var(--surface) 100%); border: 1px solid color-mix(in srgb, var(--cat-accent) 30%, var(--border)); border-radius: var(--radius-lg); padding: 20px; display: flex; flex-direction: column; gap: 10px; }
.libre-prompt { font-size: 13px; color: var(--text2); font-weight: 500; }
.libre-input { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; color: var(--text); font-family: var(--font-body); font-size: 16px; line-height: 1.5; resize: none; min-height: 110px; width: 100%; transition: border-color 0.2s; }
.libre-input:focus { outline: none; border-color: #48CAE4; }
.libre-input::placeholder { color: var(--text3); }
.libre-chars { font-size: 11px; color: var(--text3); text-align: right; }
.libre-actions { display: flex; justify-content: center; }

/* ── BILAN ───────────────────────────────────────────────────── */
.bilan-container { padding: 8px 20px 32px; display: flex; flex-direction: column; gap: 16px; }
.bilan-intro { display: flex; flex-direction: column; align-items: center; gap: 10px; text-align: center; }
.bilan-icon { font-size: 36px; }
.bilan-intro p { font-size: 13px; color: var(--text2); line-height: 1.6; max-width: 320px; }
.generate-passage-btn { display: flex; align-items: center; gap: 8px; background: color-mix(in srgb, #C084FC 15%, var(--surface)); border: 1px solid color-mix(in srgb, #C084FC 40%, transparent); border-radius: 100px; padding: 11px 24px; color: #C084FC; font-family: var(--font-body); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.generate-passage-btn:hover { background: color-mix(in srgb, #C084FC 25%, var(--surface)); transform: scale(1.02); }
.generate-passage-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
.generate-passage-btn svg { width: 16px; height: 16px; }
.bilan-passage-card { background: var(--surface); border: 1px solid color-mix(in srgb, #C084FC 25%, var(--border)); border-radius: var(--radius-lg); padding: 20px; }
.bilan-tip {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  font-size: 12px;
  color: var(--text3);
  line-height: 1.5;
  padding: 0 4px;
}

.bilan-empty { text-align: center; padding: 32px 20px; color: var(--text3); font-size: 14px; line-height: 1.6; }
/* ── PASSAGE NUMBER STRIP CAROUSEL ──────────────────────────── */
.read-num-strip {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 4px 0 2px;
  min-height: 40px;
}
.pnum-btn {
  border-radius: 50%;
  border: 2px solid;
  font-family: var(--font-display);
  font-weight: 800;
  cursor: pointer;
  transition: all 0.18s cubic-bezier(0.34,1.56,0.64,1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.pnum-btn:active { transform: scale(0.88); }
.pnum-active { box-shadow: 0 0 12px 2px color-mix(in srgb, currentColor 40%, transparent); }
.pnum-add {
  width: 26px !important;
  height: 26px !important;
  font-size: 18px !important;
  font-weight: 400 !important;
  border-color: #F59E0B !important;
  color: #F59E0B !important;
  background: transparent !important;
}

/* ── RECORD RING (side by side with score ring) ─────────────── */
.score-display {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.record-ring-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.score-ring-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text3);
}
/* When record ring is present, lay rings side by side */
.score-display:has(.record-ring-wrap) {
  flex-direction: row;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
}
.score-display:has(.record-ring-wrap) .score-feedback {
  width: 100%;
  text-align: center;
  order: 10;
}
.score-display:has(.record-ring-wrap) .score-sub-row {
  width: 100%;
  order: 11;
}
.score-display:has(.record-ring-wrap) .score-ring {
  width: 90px;
  height: 90px;
}
.score-display:has(.record-ring-wrap) .score-ring .score-number {
  font-size: 22px !important;
}
.score-display:has(.record-ring-wrap) .record-ring-wrap .score-ring {
  width: 80px;
  height: 80px;
}

/* ── READ PASSAGE WRAP (card + chevrons inline) ──────────────── */
.read-passage-wrap {
  display: flex;
  align-items: center;
  gap: 0;
  width: 100%;
  position: relative;
}
.read-chev {
  background: transparent;
  border: none;
  padding: 8px 4px;
  cursor: pointer;
  flex-shrink: 0;
  transition: opacity 0.2s, transform 0.15s;
  display: flex;
  align-items: center;
}
.read-chev:active { transform: scale(0.85); }
.read-chev svg { width: 24px; height: 24px; filter: drop-shadow(0 0 4px currentColor); }
.read-chev.invisible { visibility: hidden; pointer-events: none; }
.read-chev-l { padding-right: 6px; }
.read-chev-r { padding-left: 6px; }
.read-passage-wrap .passage-card { flex: 1; min-width: 0; }

/* ── NUMBERED PASSAGE/WORD BUTTONS ──────────────────────────── */
.passage-num-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 2px solid;
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 800;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.passage-num-btn:active { transform: scale(0.9); }
.passage-add-btn {
  font-size: 18px !important;
  font-weight: 400 !important;
}
.carousel-num-btn {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 2px solid;
  font-family: var(--font-display);
  font-size: 11px;
  font-weight: 800;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.carousel-num-btn:active { transform: scale(0.88); }

/* ── READ CAROUSEL LAYOUT ────────────────────────────────────── */
/* .read-carousel/.read-center/.read-passage-nums replaced by read-num-strip */
.passage-best-score {
  display: flex;
  align-items: center;
  gap: 4px;
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 700;
}

/* Bonus passage card */
.bonus-passage {
  border-color: rgba(245,158,11,0.35) !important;
  background: linear-gradient(135deg, rgba(245,158,11,0.06) 0%, var(--surface) 100%) !important;
}
.bonus-badge {
  font-size: 11px;
  font-weight: 700;
  color: #F59E0B;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 6px;
}

/* invisible arrow placeholder keeps layout stable */
.invisible { visibility: hidden; pointer-events: none; }

/* ── WORD ANNOTATION OVERLAY ─────────────────────────────────── */
.annotate-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 8px auto 0;
  background: color-mix(in srgb, #C084FC 12%, var(--surface));
  border: 1px solid color-mix(in srgb, #C084FC 35%, transparent);
  border-radius: 100px;
  padding: 9px 20px;
  color: #C084FC;
  font-family: var(--font-body);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.annotate-btn:hover { background: color-mix(in srgb, #C084FC 22%, var(--surface)); }
.annotate-btn svg { width: 16px; height: 16px; }

.annotation-overlay {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.ann-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.ann-legend-item { display: flex; align-items: center; gap: 4px; }
.ann-text {
  font-size: 15px;
  line-height: 2.2;
  color: var(--text);
}
.ann-word {
  position: relative;
  display: inline;
  border-radius: 4px;
  padding: 1px 3px;
  cursor: default;
  transition: all 0.15s;
}
.ann-score {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg);
  border: 1px solid var(--border-bright);
  border-radius: 6px;
  padding: 3px 7px;
  font-size: 10px;
  font-weight: 700;
  white-space: nowrap;
  z-index: 10;
  pointer-events: none;
}
.ann-word:hover .ann-score,
.ann-word:active .ann-score { display: block; }
.ann-good    { background: rgba(52,211,153,0.18); color: #34D399; border-bottom: 2px solid #34D399; }
.ann-ok      { background: rgba(251,191,36,0.15); color: #FBBF24; border-bottom: 2px solid #FBBF24; }
.ann-bad     { background: rgba(248,113,113,0.18); color: #F87171; border-bottom: 2px solid #F87171; }
.ann-omission{ background: rgba(156,163,175,0.15); color: #9CA3AF; border-bottom: 2px dashed #9CA3AF; text-decoration: line-through; }
.ann-neutral { color: var(--text); }

.labo-scores-empty {
  text-align: center;
  padding: 48px 24px;
  color: var(--text2);
  font-size: 14px;
  line-height: 1.6;
}

.bilan-saved-msg { font-size: 12px; color: var(--text2); text-align: center; padding: 6px 12px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border); }

/* ── BILAN SCORES SECTION ────────────────────────────────────── */
.bilan-summary-section { background: color-mix(in srgb, #3D0066 15%, var(--surface)); border: 1px solid color-mix(in srgb, #C084FC 30%, var(--border)); border-radius: var(--radius-lg); padding: 20px; display: flex; flex-direction: column; gap: 12px; margin-top: 8px; }
.bilan-summary-header { display: flex; align-items: center; justify-content: space-between; }
.bilan-summary-title { font-size: 14px; font-weight: 700; color: #C084FC; }
.bilan-redo-btn { display: flex; align-items: center; gap: 6px; background: transparent; border: 1px solid color-mix(in srgb, #C084FC 40%, transparent); border-radius: 100px; padding: 6px 14px; color: #C084FC; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.bilan-redo-btn:hover { background: color-mix(in srgb, #C084FC 15%, transparent); }
.bilan-redo-btn svg { width: 13px; height: 13px; }
.bilan-summary-note { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; }
.bilan-cat-list { display: flex; flex-direction: column; gap: 8px; }
.bilan-cat-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--surface); border-radius: var(--radius-sm); border: 1px solid var(--border); }
.bilan-cat-name { font-size: 13px; font-weight: 600; }
.bilan-cat-scores { display: flex; align-items: center; gap: 6px; }
.bilan-score-latest { font-family: var(--font-display); font-size: 14px; font-weight: 700; }
.bilan-score-sep { color: var(--text3); font-size: 12px; }
.bilan-score-best { font-family: var(--font-display); font-size: 12px; font-weight: 700; opacity: 0.85; }
.bilan-cat-pill { font-family: var(--font-display); font-size: 11px; font-weight: 700; margin-left: 8px; background: var(--surface); border-radius: 6px; padding: 2px 6px; border: 1px solid var(--border); }

/* ── LABO THEME ──────────────────────────────────────────────── */

/* Beaker button on home — glows teal */
.labo-btn {
  color: #00F5D4 !important;
  position: relative;
}
.labo-btn svg {
  filter: drop-shadow(0 0 6px rgba(0,245,212,0.5));
}

/* Labo header background wash */
.labo-header {
  position: relative;
}
.labo-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(0,245,212,0.07) 0%, transparent 70%);
  pointer-events: none;
  border-radius: inherit;
}

/* Labo logo */
.labo-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}
.labo-logo-icon {
  width: 28px;
  height: 28px;
  color: #00F5D4;
  filter: drop-shadow(0 0 8px rgba(0,245,212,0.6));
  flex-shrink: 0;
}
.labo-title {
  font-family: var(--font-display);
  font-size: 26px;
  font-weight: 800;
  background: linear-gradient(135deg, #00F5D4 0%, #2DD4BF 50%, #67E8F9 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.02em;
}
.labo-tagline {
  font-size: 12px;
  color: #2DD4BF !important;
  opacity: 0.8;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-weight: 600;
}

/* Home button inside labo header */
.labo-home-btn {
  color: #C084FC !important;
}
.labo-home-btn svg {
  filter: drop-shadow(0 0 6px rgba(192,132,252,0.55));
}
.labo-scores-btn {
  color: #00F5D4 !important;
}
.labo-scores-btn svg {
  filter: drop-shadow(0 0 5px rgba(0,245,212,0.4));
}

/* Labo grid — same layout as home */
.labo-grid {
  /* inherits .category-grid styles */
}

/* Labo tiles — teal family glow overrides */
.labo-tile {
  position: relative;
  overflow: hidden;
}
.labo-tile::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 30% 30%, color-mix(in srgb, var(--cat-accent) 12%, transparent), transparent 70%);
  pointer-events: none;
}
.labo-tile:hover {
  box-shadow: 0 0 0 1px var(--cat-accent), 0 4px 24px color-mix(in srgb, var(--cat-accent) 20%, transparent);
}
.labo-tile .cat-icon {
  font-size: 28px;
}
.labo-tile .cat-label {
  color: var(--cat-accent);
}

/* Coming soon tiles */
.labo-coming-soon {
  opacity: 0.55;
  cursor: default;
}
.labo-coming-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: color-mix(in srgb, var(--cat-accent) 20%, transparent);
  border: 1px solid color-mix(in srgb, var(--cat-accent) 40%, transparent);
  border-radius: 100px;
  padding: 2px 8px;
  font-size: 10px;
  font-weight: 700;
  color: var(--cat-accent);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

/* Labo screen headers (for Phrase libre / Bilan sub-screens) */
.labo-screen-accent { color: #00F5D4; }

/* ── TILE LOCKED ─────────────────────────────────────────────── */
.tile-locked { opacity: 0.5; filter: grayscale(0.6); cursor: not-allowed; }

/* ── TOAST ───────────────────────────────────────────────────── */
.toast-msg { position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--surface2); border: 1px solid var(--border-bright); border-radius: 100px; padding: 12px 24px; font-size: 13px; color: var(--text); text-align: center; opacity: 0; transition: opacity 0.3s, transform 0.3s; z-index: 999; max-width: 320px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); pointer-events: none; }
.toast-msg.toast-show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ── UTILITIES ───────────────────────────────────────────────── */
button { font-family: var(--font-body); -webkit-tap-highlight-color: transparent; }

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
}

  </style>
</head>
<body>
  <div id="app">
    <main id="main"></main>
  </div>

  <script>
// ============================================================
// PHONÉTIQUE APP — DATA
// ============================================================

const APP_DATA = {

  categories: [
    {
      id: 'nasales',
      label: 'Voyelles nasales',
      icon: '〜',
      color: '#7C3AED',
      accent: '#A78BFA',
      description: 'Les sons an, in, on, un',
      phonemes: ['an', 'in', 'on', 'un']
    },
    {
      id: 'arrondies',
      label: 'Voyelles arrondies',
      icon: '○',
      color: '#2563EB',
      accent: '#60A5FA',
      description: 'Les sons u, eu, eux',
      phonemes: ['u', 'eu_ferme', 'eu_ouvert']
    },
    {
      id: 'moyennes',
      label: 'Voyelles moyennes',
      icon: '◇',
      color: '#0891B2',
      accent: '#22D3EE',
      description: 'Les contrastes é/è, o/ô',
      phonemes: ['e_ferme', 'e_ouvert', 'o_ferme', 'o_ouvert']
    },
    {
      id: 'terminaisons',
      label: 'Terminaisons',
      icon: '→',
      color: '#059669',
      accent: '#34D399',
      description: 'Les fins muettes -ent, -er, -ez',
      phonemes: ['ent_muet', 'er_ez', 'es_muet', 'tion']
    },
    {
      id: 'consonnes',
      label: 'R & Consonnes',
      icon: 'ʁ',
      color: '#DC2626',
      accent: '#F87171',
      description: 'Le R français, gn, ll',
      phonemes: ['r_français', 'gn', 'ill']
    },
    {
      id: 'liaison',
      label: 'Liaison',
      icon: '⌒',
      color: '#D97706',
      accent: '#FCD34D',
      description: 'Enchaînements et liaisons',
      phonemes: ['liaison_obligatoire', 'liaison_consonantique', 'enchainement']
    }
  ],

  phonemes: {

    // ── NASALES ──────────────────────────────────────────────
    'an': {
      label: 'AN / EN',
      ipa: '/ɑ̃/',
      category: 'nasales',
      description: 'Voyelle nasale postérieure. Bouche mi-ouverte, air passe par le nez.',
      graphies: ['an', 'am', 'en', 'em', 'aon'],
      exemples: ['maman', 'enfant', 'temps', 'chambre', 'blanc'],
      practiceWords: [
        ['enfant', '/ɑ̃fɑ̃/'],
        ['champ', '/ʃɑ̃/'],
        ['temps', '/tɑ̃/'],
        ['blanc', '/blɑ̃/'],
        ['maman', '/mamɑ̃/']
      ],
      confusedWith: ['in', 'on'],
      passages: [
        {
          id: 'an_p1',
          text: "Le grand enfant marche lentement dans le champ. Il prend le temps d'admirer les plantes et les branches blanches. Sa maman l'attend patiemment à la maison.",
          highlight: /\b(en|an|am|em)\w*/gi
        },
        {
          id: 'an_p2',
          text: "En automne, les enfants ramassent des glands. Ils avancent ensemble dans les rangs de grands arbres centenaires. Le vent murmure doucement dans les feuilles tremblantes.",
          highlight: /\b\w*(an|en|am|em)\w*/gi
        },
        {
          id: 'an_p3',
          text: "Pendant longtemps, Léandre a vécu dans une grande maison blanche. Il aimait se promener dans les champs environnants et contempler l'étendue du paysage en silence.",
          highlight: /\b\w*(an|en|am|em)\w*/gi
        },
        {
          id: 'an_p4',
          text: "La chambre sent la lavande. Amanda range tranquillement ses affaires avant de s'endormir. Demain, elle partira en camping avec ses grands-parents dans la montagne.",
          highlight: /\b\w*(an|en|am|em)\w*/gi
        },
        {
          id: 'an_p5',
          text: "Les étudiants apprennent le français en chantant. Pendant les cours, ils pratiquent les sons nasaux avec enthousiasme. L'enseignante est contente de leurs progrès constants.",
          highlight: /\b\w*(an|en|am|em)\w*/gi
        }
      ]
    },

    'in': {
      label: 'IN / AIN',
      ipa: '/ɛ̃/',
      category: 'nasales',
      description: 'Voyelle nasale antérieure. Bouche mi-fermée, lèvres écartées, air par le nez.',
      graphies: ['in', 'im', 'ain', 'ein', 'un', 'yn'],
      exemples: ['lapin', 'main', 'vin', 'pain', 'fin'],
      practiceWords: [
        ['lapin', '/lapɛ̃/'],
        ['pain', '/pɛ̃/'],
        ['main', '/mɛ̃/'],
        ['vin', '/vɛ̃/'],
        ['fin', '/fɛ̃/']
      ],
      confusedWith: ['an', 'on'],
      passages: [
        {
          id: 'in_p1',
          text: "Le lapin affamé cherche son pain dans le jardin. Demain matin, il ira rejoindre ses cousins au bord du bassin. Chemin faisant, il croisera le voisin.",
          highlight: null
        },
        {
          id: 'in_p2',
          text: "Martin tient un verre de vin à la main. Il invite ses voisins à un repas simple mais fin. Sa cuisine est divine, pleine de thym et de romarin.",
          highlight: null
        },
        {
          id: 'in_p3',
          text: "Cinq musiciens jouent pour les pèlerins. Le refrain résonne enfin dans la plaine. Nul besoin de tambourin — leurs voix suffisent à remplir le théâtre.",
          highlight: null
        },
        {
          id: 'in_p4',
          text: "Sabine peint chaque matin dans son jardin. Elle aime les couleurs claires, les teintes pastel, les lignes fines. Son prochain tableau représentera un paysage marin.",
          highlight: null
        },
        {
          id: 'in_p5',
          text: "Le médecin examine le patient avec soin. Il prescrit de l'eau, du repos, et un peu de pain grillé. Demain, le petit ira beaucoup mieux, c'est certain.",
          highlight: null
        }
      ]
    },

    'on': {
      label: 'ON',
      ipa: '/ɔ̃/',
      category: 'nasales',
      description: 'Voyelle nasale postérieure. Lèvres arrondies, air par le nez.',
      graphies: ['on', 'om'],
      exemples: ['maison', 'bonbon', 'pont', 'ombre', 'nom'],
      practiceWords: [
        ['maison', '/mɛzɔ̃/'],
        ['pont', '/pɔ̃/'],
        ['bonbon', '/bɔ̃bɔ̃/'],
        ['balcon', '/balkɔ̃/'],
        ['nom', '/nɔ̃/']
      ],
      confusedWith: ['an', 'in'],
      passages: [
        {
          id: 'on_p1',
          text: "Le ballon bondit sur le pont. Gaston observe depuis le balcon de sa maison. Il prend son téléphone pour appeler son compagnon de jeu, Léon.",
          highlight: null
        },
        {
          id: 'on_p2',
          text: "Selon la tradition, on mange de la fondue en montagne. Le bouillon réchauffe les convives. Au fond du chaudron, le fromage fond doucement sous les oignons.",
          highlight: null
        },
        {
          id: 'on_p3',
          text: "Mon oncle Edmond compose des chansons. Il joue de l'accordéon le long du boulevard. Les passants s'arrêtent, frappent des mains et chantent en réponse à sa chanson.",
          highlight: null
        },
        {
          id: 'on_p4',
          text: "Nous sommes tombés sur une solution fonctionnelle. Notre patron est contenu du résultat. Selon nos prévisions, la production continuera longtemps dans cette direction.",
          highlight: null
        },
        {
          id: 'on_p5',
          text: "Le bouton tombé du manteau d'Yvonne roulait sur les dalles du couloir. Bontemps le ramassa, hésita un instant, puis le tendit à sa voisine avec un bon sourire.",
          highlight: null
        }
      ]
    },

    'un': {
      label: 'UN / UM',
      ipa: '/œ̃/',
      category: 'nasales',
      description: 'Voyelle nasale antérieure arrondie. Lèvres arrondies et avancées, air par le nez. Souvent fusionné avec /ɛ̃/ en français québécois.',
      graphies: ['un', 'um', 'eun'],
      exemples: ['lundi', 'brun', 'humble', 'parfum', 'jeun'],
      practiceWords: [
        ['parfum', '/paʁfœ̃/'],
        ['brun', '/bʁœ̃/'],
        ['lundi', '/lœ̃di/'],
        ['humble', '/œ̃bl/'],
        ['chacun', '/ʃakœ̃/']
      ],
      confusedWith: ['in', 'on'],
      passages: [
        {
          id: 'un_p1',
          text: "Un brun inconnu est apparu lundi matin. Il portait un costume humble mais élégant, et dégageait un parfum subtil. Chacun se demandait qui il était.",
          highlight: null
        },
        {
          id: 'un_p2',
          text: "À jeun, Bruno réfléchit à chaque opportunité. Il cherche un emploi, quelque chose d'utile. Un jour ou l'autre, il en trouvera un, il en est persuadé.",
          highlight: null
        },
        {
          id: 'un_p3',
          text: "Certun préfère le brun, d'autres le blond. Chacun ses goûts, dit-on. Un conseil commun : choisissez avec soin, car un mauvais choix peut durer longtemps.",
          highlight: null
        },
        {
          id: 'un_p4',
          text: "Jules a emprunté un umbrella à son voisin. Il est rentré à jeun, le ventre creux mais heureux. C'était un lundi comme un autre, ordinaire mais plein d'humour.",
          highlight: null
        },
        {
          id: 'un_p5',
          text: "Un parfum de jasmin flottait dans l'air du matin. C'était quelque chose d'humble et de pur à la fois. Un instant fugace, mais inoubliable — un vrai trésor commun.",
          highlight: null
        }
      ]
    },

    // ── ARRONDIES ────────────────────────────────────────────
    'u': {
      label: 'U',
      ipa: '/y/',
      category: 'arrondies',
      description: 'Voyelle antérieure arrondie. Lèvres très arrondies comme pour dire "ou" mais langue vers l\'avant.',
      graphies: ['u', 'û', 'eu (certains mots)'],
      exemples: ['lune', 'rue', 'vu', 'sur', 'mûr'],
      practiceWords: [
        ['lune', '/lyn/'],
        ['rue', '/ʁy/'],
        ['mur', '/myʁ/'],
        ['vue', '/vy/'],
        ['sur', '/syʁ/']
      ],
      confusedWith: ['eu_ferme', 'ou'],
      passages: [
        {
          id: 'u_p1',
          text: "La lune brille sur la rue silencieuse. Vue du dessus, la ville ressemble à une sculpture. Lucas et Julie marchent, perdus dans leurs pensées.",
          highlight: null
        },
        {
          id: 'u_p2',
          text: "Tu as lu ce livre? J'en suis sûr, il t'a plu. C'est une étude unique sur la nature humaine. Lucie l'a traduit elle-même, avec beaucoup de subtilité.",
          highlight: null
        },
        {
          id: 'u_p3',
          text: "Sur le mur, une sculpture représente une figure mystérieuse. La lumière du musée lui donne une allure inusitée. Les visiteurs restent ébahis, la bouche ouverte.",
          highlight: null
        },
        {
          id: 'u_p4',
          text: "Durant l'été, Hugues suit des cours de musique. Il joue de la flûte dans une salle exiguë mais chaleureuse. Sa professeure, Luce, lui enseigne avec patience.",
          highlight: null
        },
        {
          id: 'u_p5',
          text: "Un pur hasard a réuni Jules et Lucie devant ce tableau. Une minute suffisait pour comprendre qu'ils partageaient le même goût pour la culture et la beauté.",
          highlight: null
        }
      ]
    },

    'eu_ferme': {
      label: 'EU fermé',
      ipa: '/ø/',
      category: 'arrondies',
      description: 'Voyelle antérieure mi-fermée arrondie. Comme /e/ mais avec les lèvres arrondies.',
      graphies: ['eu', 'œu', 'eux', '-euse'],
      exemples: ['feu', 'jeu', 'heureux', 'chanteuse', 'deux'],
      practiceWords: [
        ['feu', '/fø/'],
        ['deux', '/dø/'],
        ['jeu', '/ʒø/'],
        ['bleu', '/blø/'],
        ['heureux', '/øʁø/']
      ],
      confusedWith: ['eu_ouvert', 'u'],
      passages: [
        {
          id: 'eu_f_p1',
          text: "Deux amoureux jouent au jeu de cartes près du feu. Leurs yeux brillent sous la lueur des flammes. C'est un moment heureux et précieux.",
          highlight: null
        },
        {
          id: 'eu_f_p2',
          text: "La chanteuse est heureuse ce soir. Ses cheveux bleus brillent sous les projecteurs. Le public veut encore deux chansons avant la fin du spectacle.",
          highlight: null
        },
        {
          id: 'eu_f_p3',
          text: "Mathieu veut un peu de thé. Sa sœur lui apporte un bol bleué et chaud. Ils s'assoient ensemble devant la cheminée, heureux de ce moment paisible.",
          highlight: null
        },
        {
          id: 'eu_f_p4',
          text: "Il pleut doucement. Les gens se réfugient dans des cafés chaleureux. Un vieil homme commande deux cafés, l'un pour lui, l'autre pour son chien aux yeux doux.",
          highlight: null
        },
        {
          id: 'eu_f_p5',
          text: "Monsieur Lebleu est un professeur sérieux mais généreux. Il enseigne depuis peu dans cette école. Ses élèves sont studieux et font de leur mieux chaque jour.",
          highlight: null
        }
      ]
    },

    'eu_ouvert': {
      label: 'EU ouvert',
      ipa: '/œ/',
      category: 'arrondies',
      description: 'Voyelle antérieure mi-ouverte arrondie. Bouche plus ouverte que /ø/.',
      graphies: ['eu', 'œu', '-eur', '-euse (certains)'],
      exemples: ['peur', 'heure', 'sœur', 'beurre', 'cœur'],
      practiceWords: [
        ['peur', '/pœʁ/'],
        ['coeur', '/kœʁ/'],
        ['heure', '/œʁ/'],
        ['soeur', '/sœʁ/'],
        ['beurre', '/bœʁ/']
      ],
      confusedWith: ['eu_ferme', 'e_ouvert'],
      passages: [
        {
          id: 'eu_o_p1',
          text: "À cette heure, ma sœur a peur de sortir seule. Son cœur bat fort. Elle préfère attendre le retour de son frère, le beurre sur la table refroidissant lentement.",
          highlight: null
        },
        {
          id: 'eu_o_p2',
          text: "Le professeur explique l'erreur avec douceur. À l'heure du déjeuner, il offre du beurre frais et du meilleur pain du quartier. C'est sa manière de créer une bonne humeur.",
          highlight: null
        },
        {
          id: 'eu_o_p3',
          text: "Leur maison de banlieue sent le beurre et la fleur d'oranger. La chaleur est douce à cette heure du matin. Chacun s'active avec un cœur léger.",
          highlight: null
        },
        {
          id: 'eu_o_p4',
          text: "Fleur a peur du tonnerre. À chaque orage, son cœur se serre. Sa grand-mère la prend dans ses bras avec douceur et lui murmure des mots réconfortants à l'oreille.",
          highlight: null
        },
        {
          id: 'eu_o_p5',
          text: "Le danseur tourne à toute allure. Malgré la sueur sur son front, son cœur est en feu. Pendant une heure, il ne fera qu'un avec la musique.",
          highlight: null
        }
      ]
    },

    // ── MOYENNES ─────────────────────────────────────────────
    'e_ferme': {
      label: 'É fermé',
      ipa: '/e/',
      category: 'moyennes',
      description: 'Voyelle antérieure mi-fermée non arrondie. Lèvres écartées, mâchoire légèrement fermée.',
      graphies: ['é', 'er', 'ez', 'es (certains mots)', 'et (certains)'],
      exemples: ['été', 'chanter', 'nez', 'les', 'café'],
      practiceWords: [
        ['été', '/ete/'],
        ['café', '/kafe/'],
        ['nez', '/ne/'],
        ['chanter', '/ʃɑ̃te/'],
        ['bébé', '/bebe/']
      ],
      confusedWith: ['e_ouvert'],
      passages: [
        {
          id: 'ef_p1',
          text: "Élodie a passé l'été à chanter dans le café du quartier. Elle préférait jouer des mélodies légères, des ballades ensoleillées qui égayaient les habitués.",
          highlight: null
        },
        {
          id: 'ef_p2',
          text: "Le boulanger a préparé des galettes pour le marché. Les enfants se pressent pour en acheter, le nez en l'air, attirés par les arômes dorés qui s'échappent de la boulangerie.",
          highlight: null
        },
        {
          id: 'ef_p3',
          text: "Rémy est arrivé le premier à la réunion. Il a posé ses clés sur la table et commandé un café bien serré. La réunion s'est déroulée de façon très structurée.",
          highlight: null
        },
        {
          id: 'ef_p4',
          text: "Les étoiles brillaient ce soir-là dans la vallée. La fée de la forêt, dit-on, y dansait entourée de lumières. C'était un spectacle féerique, léger et enchanté.",
          highlight: null
        },
        {
          id: 'ef_p5',
          text: "Mélanie a décidé de déménager près de la mer. Elle ira chercher un appartement déjà meublé avec une jolie terrasse. Elle en rêvait depuis l'été dernier.",
          highlight: null
        }
      ]
    },

    'e_ouvert': {
      label: 'È ouvert',
      ipa: '/ɛ/',
      category: 'moyennes',
      description: 'Voyelle antérieure mi-ouverte non arrondie. Bouche légèrement plus ouverte que /e/.',
      graphies: ['è', 'ê', 'ei', 'ai', 'e + consonne finale'],
      exemples: ['fête', 'tête', 'lait', 'neige', 'sel'],
      practiceWords: [
        ['tête', '/tɛt/'],
        ['lait', '/lɛ/'],
        ['neige', '/nɛʒ/'],
        ['fête', '/fɛt/'],
        ['sel', '/sɛl/']
      ],
      confusedWith: ['e_ferme'],
      passages: [
        {
          id: 'eo_p1',
          text: "La tête dans les nuages, Hélène se promenait près de la forêt. Elle aimait écouter les oiseaux chanter dans les branches de chêne. Le lait refroidissait sur la table.",
          highlight: null
        },
        {
          id: 'eo_p2',
          text: "La neige tombait en silence sur le marché de Noël. Les gens portaient des bonnets et des écharpes épaisses. Une odeur de lait chaud flottait dans l'air glacé.",
          highlight: null
        },
        {
          id: 'eo_p3',
          text: "Élève très sérieuse, Estelle s'intéresse à la fête des lumières. Elle prépare une crêpe avec du sel et du beurre, la tête penchée sur son livre ouvert.",
          highlight: null
        },
        {
          id: 'eo_p4',
          text: "La baleine nageait près de la baie, indifférente au froid. Son souffle dessinait de légères vapeurs dans l'air. La scène était paisible, presque irréelle.",
          highlight: null
        },
        {
          id: 'eo_p5',
          text: "Michel achète du lait frais chaque matin au marché. Il laisse la fenêtre ouverte pour sentir le vent frais. La cafetière répand une odeur de café bien serré.",
          highlight: null
        }
      ]
    },

    'o_ferme': {
      label: 'O fermé',
      ipa: '/o/',
      category: 'moyennes',
      description: 'Voyelle postérieure mi-fermée arrondie. Lèvres bien arrondies, mâchoire légèrement fermée.',
      graphies: ['ô', 'au', 'eau', 'o (fin de mot)'],
      exemples: ['beau', 'eau', 'gâteau', 'côte', 'chapeau'],
      practiceWords: [
        ['gâteau', '/ɡɑto/'],
        ['beau', '/bo/'],
        ['eau', '/o/'],
        ['chapeau', '/ʃapo/'],
        ['côte', '/kot/']
      ],
      confusedWith: ['o_ouvert'],
      passages: [
        {
          id: 'of_p1',
          text: "Paulo a préparé un beau gâteau au chocolat. La côte du port est visible depuis son beau bureau. Il s'est levé tôt pour aller chercher de l'eau fraîche.",
          highlight: null
        },
        {
          id: 'of_p2',
          text: "Au bord de l'eau, des bateaux oscillent doucement. Les enfants posent leurs chapeaux sur la plage et sautent dans les vagues. Tout est beau et paisible.",
          highlight: null
        },
        {
          id: 'of_p3',
          text: "Margot adore les cerises, les choux et les artichauts. Elle prépare un plateau garni pour le repas de côte. Un couteau et une fourchette suffisent pour ce beau festin.",
          highlight: null
        },
        {
          id: 'of_p4',
          text: "Le nouveau tableau est exposé côté gauche. Il représente des oiseaux au bord de l'eau. L'artiste a utilisé beaucoup de teintes dorées pour rappeler le soleil couchant.",
          highlight: null
        },
        {
          id: 'of_p5',
          text: "Rodrigo pose un vase sur le piano. Il y glisse un bouquet de fleurs fraîchement coupées. Ce geste simple rend l'appartement bien plus chaleureux et beau.",
          highlight: null
        }
      ]
    },

    'o_ouvert': {
      label: 'O ouvert',
      ipa: '/ɔ/',
      category: 'moyennes',
      description: 'Voyelle postérieure mi-ouverte arrondie. Bouche plus ouverte que /o/.',
      graphies: ['o (en syllabe ouverte)', 'o + consonne'],
      exemples: ['or', 'porte', 'sol', 'col', 'fort'],
      practiceWords: [
        ['porte', '/pɔʁt/'],
        ['or', '/ɔʁ/'],
        ['sol', '/sɔl/'],
        ['fort', '/fɔʁ/'],
        ['col', '/kɔl/']
      ],
      confusedWith: ['o_ferme'],
      passages: [
        {
          id: 'oo_p1',
          text: "Victor frappe à la porte. Dehors, le sol est mouillé. Il sort un morceau de chocolat de sa poche et l'offre à l'homme qui lui ouvre la porte d'or.",
          highlight: null
        },
        {
          id: 'oo_p2',
          text: "Le docteur habite au bord du port. Ses collègues le respectent beaucoup. Il porte toujours un costume sombre et parle avec une voix forte mais douce.",
          highlight: null
        },
        {
          id: 'oo_p3',
          text: "La forêt est profonde et forte ce matin. L'odeur des feuilles mortes monte du sol. Un corbeau noir se pose sur une branche tordue, silencieux comme une ombre.",
          highlight: null
        },
        {
          id: 'oo_p4',
          text: "Dorothée sort tôt pour trouver du chocolat chaud. Elle marche vite sur le sol gelé. Au coin de la rue, une boutique ouvre ses portes et répand une douce odeur.",
          highlight: null
        },
        {
          id: 'oo_p5',
          text: "Le sort en est jeté, dit Norbert. Il porte son projet comme un trésor. Sa collègue Oriane l'encourage à persévérer. Ensemble, ils travailleront fort jusqu'au bout.",
          highlight: null
        }
      ]
    },

    // ── TERMINAISONS ─────────────────────────────────────────
    'ent_muet': {
      label: '-ENT muet',
      ipa: '(muet)',
      category: 'terminaisons',
      description: 'La terminaison -ent des verbes conjugués est totalement muette. Ils parlent = /ilpaʁl/.',
      graphies: ['-ent (3e pluriel verbe)'],
      exemples: ['ils parlent', 'elles chantent', 'ils viennent', 'elles dorment', 'ils finissent'],
      practiceWords: [
        ['ils parlent', '/ilpaʁl/'],
        ['elles chantent', '/ɛlʃɑ̃t/'],
        ['ils viennent', '/ilvjɛn/'],
        ['ils lisent', '/illiz/'],
        ['elles dorment', '/ɛldɔʁm/']
      ],
      confusedWith: ['tion'],
      passages: [
        {
          id: 'ent_p1',
          text: "Les enfants parlent doucement. Ils chantent une chanson et dansent ensemble. Leurs parents les regardent et sourient. Ils semblent heureux et insouciants.",
          highlight: null
        },
        {
          id: 'ent_p2',
          text: "Les oiseaux chantent dès l'aube. Ils volent haut, tournoient, puis plongent vers la rivière. Les promeneurs s'arrêtent et les admirent en silence.",
          highlight: null
        },
        {
          id: 'ent_p3',
          text: "Les élèves finissent leur devoir. Ils lisent attentivement, réfléchissent, puis écrivent. Certains hésitent, d'autres avancent vite. Ensemble, ils progressent.",
          highlight: null
        },
        {
          id: 'ent_p4',
          text: "Les musiciens accordent leurs instruments. Ils jouent quelques notes, s'écoutent mutuellement, puis s'arrêtent. Enfin, ils commencent le concert.",
          highlight: null
        },
        {
          id: 'ent_p5',
          text: "Les cuisiniers préparent le repas. Ils épluchent les légumes, les coupent, les font cuire. Ils goûtent régulièrement et ajustent les épices.",
          highlight: null
        }
      ]
    },

    'er_ez': {
      label: '-ER / -EZ',
      ipa: '/e/',
      category: 'terminaisons',
      description: 'Les terminaisons -er (infinitif) et -ez (vous) se prononcent /e/, pas /ɛʁ/ ou /ɛz/.',
      graphies: ['-er', '-ez'],
      exemples: ['parler', 'chanter', 'vous parlez', 'vous chantez', 'aller'],
      practiceWords: [
        ['parler', '/paʁle/'],
        ['chanter', '/ʃɑ̃te/'],
        ['aller', '/ale/'],
        ['vous parlez', '/vupaʁle/'],
        ['manger', '/mɑ̃ʒe/']
      ],
      confusedWith: ['e_ferme', 'e_ouvert'],
      passages: [
        {
          id: 'er_p1',
          text: "Vous aimez chanter et parler français? Il faut pratiquer chaque jour, écouter, répéter. Vous allez progresser si vous continuez à travailler sans vous décourager.",
          highlight: null
        },
        {
          id: 'er_p2',
          text: "Aller chercher du pain, regarder passer les gens, écouter la radio — voilà comment passer une belle journée. Vous préférez rester chez vous ou sortir et marcher?",
          highlight: null
        },
        {
          id: 'er_p3',
          text: "Pour bien prononcer, il faut écouter et imiter. Vous pouvez aussi enregistrer votre voix et comparer. N'hésitez pas à vous corriger sans vous juger.",
          highlight: null
        },
        {
          id: 'er_p4',
          text: "Pensez à articuler clairement quand vous parlez. Essayez de vous entraîner à chanter des phrases entières. Vous apprenez vite, continuez à pratiquer!",
          highlight: null
        },
        {
          id: 'er_p5',
          text: "Pour aller plus loin, vous devrez vous impliquer davantage. Écoutez, notez, mémorisez. Communiquer en français, c'est possible si vous osez essayer!",
          highlight: null
        }
      ]
    },

    'es_muet': {
      label: '-ES / -E muets',
      ipa: '(muet)',
      category: 'terminaisons',
      description: 'Les terminaisons -e, -es, -ent des adjectifs et noms sont muettes.',
      graphies: ['-e', '-es', '-le', '-re'],
      exemples: ['petite', 'grandes', 'table', 'livre', 'belle'],
      practiceWords: [
        ['petite fille', '/pətitfij/'],
        ['grande table', '/ɡʁɑ̃dtabl/'],
        ['belle maison', '/bɛlmɛzɔ̃/'],
        ['vieille dame', '/vjɛjdam/'],
        ['haute tour', '/ottuʁ/']
      ],
      confusedWith: ['e_ouvert'],
      passages: [
        {
          id: 'es_p1',
          text: "Une petite fille aux grandes boucles blondes entre dans une belle librairie. Elle cherche une table libre pour s'asseoir et feuilleter un livre tranquillement.",
          highlight: null
        },
        {
          id: 'es_p2',
          text: "Les grandes tables de la salle à manger sont jolies. Sur chaque assiette, une belle serviette blanche est posée. Une odeur douce et agréable flotte dans la pièce.",
          highlight: null
        },
        {
          id: 'es_p3',
          text: "Cette vieille maison a une grande façade jaune et des volets verts. Une belle porte rouge invite les visiteurs à entrer. La cour intérieure est calme et ombragée.",
          highlight: null
        },
        {
          id: 'es_p4',
          text: "Les feuilles mortes couvrent les grandes allées du parc. Une vieille femme marche lentement, les mains dans les poches de sa belle veste grise.",
          highlight: null
        },
        {
          id: 'es_p5',
          text: "Elle choisit une table près de la fenêtre. Sur la nappe blanche trône une belle bougie allumée. Elle commande une tasse de thé chaud et ouvre son livre préféré.",
          highlight: null
        }
      ]
    },

    'tion': {
      label: '-TION',
      ipa: '/sjɔ̃/',
      category: 'terminaisons',
      description: 'La terminaison -tion se prononce /sjɔ̃/, jamais /tjon/ comme en anglais.',
      graphies: ['-tion', '-sion', '-cion'],
      exemples: ['nation', 'question', 'action', 'solution', 'attention'],
      practiceWords: [
        ['question', '/kɛstjɔ̃/'],
        ['nation', '/nasjɔ̃/'],
        ['action', '/aksjɔ̃/'],
        ['solution', '/sɔlysjɔ̃/'],
        ['attention', '/atɑ̃sjɔ̃/']
      ],
      confusedWith: ['on'],
      passages: [
        {
          id: 'tion_p1',
          text: "Une question de communication. La solution est simple : faire attention à la prononciation de chaque terminaison. C'est une compétition contre ses propres habitudes de diction.",
          highlight: null
        },
        {
          id: 'tion_p2',
          text: "La nation célèbre cette occasion avec émotion. C'est une tradition vieille de plusieurs générations. Une participation large et sincère est attendue avec impatience.",
          highlight: null
        },
        {
          id: 'tion_p3',
          text: "La direction a pris une décision importante : une révolution dans l'organisation du travail. Cette transition demande beaucoup d'attention et de coopération.",
          highlight: null
        },
        {
          id: 'tion_p4',
          text: "L'institution organise une présentation sur la prévention des infections. L'action collective est la seule solution durable. La population est invitée à participer.",
          highlight: null
        },
        {
          id: 'tion_p5',
          text: "En situation d'évaluation, la concentration est essentielle. Une bonne préparation évite la frustration. C'est une affirmation que tout étudiant devrait retenir.",
          highlight: null
        }
      ]
    },

    // ── CONSONNES ─────────────────────────────────────────────
    'r_français': {
      label: 'R français',
      ipa: '/ʁ/',
      category: 'consonnes',
      description: 'Le R uvulaire. Produit à l\'arrière de la gorge, pas avec la langue comme en anglais ou espagnol.',
      graphies: ['r', 'rr'],
      exemples: ['rue', 'rouge', 'grand', 'partir', 'terre'],
      practiceWords: [
        ['rouge', '/ʁuʒ/'],
        ['rue', '/ʁy/'],
        ['grand', '/ɡʁɑ̃/'],
        ['partir', '/paʁtiʁ/'],
        ['terre', '/tɛʁ/']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'r_p1',
          text: "Romain roule sur la route rouge. Derrière lui, la forêt s'étire à perte de vue. Il ralentit, regarde, puis repart en direction de la rivière voisine.",
          highlight: null
        },
        {
          id: 'r_p2',
          text: "Chaque matin, René court le long de la rive. Le brouillard se lève sur les prés. Il respire profondément, heureux de ce rituel tranquille du lever du jour.",
          highlight: null
        },
        {
          id: 'r_p3',
          text: "La terrasse du restaurant est remplie de gens qui rient. Le garçon porte un grand plateau. Quelqu'un rit très fort et renverse malencontreusement un verre de rouge.",
          highlight: null
        },
        {
          id: 'r_p4',
          text: "Rodrigue prépare un risotto pour toute la famille. Il remue, goûte, réajuste les épices. La recette vient de sa grand-mère, une vraie ressource pour les saveurs.",
          highlight: null
        },
        {
          id: 'r_p5',
          text: "Le caractère du Rhin, c'est sa force remarquable. Le fleuve rugit entre les rochers. Les randonneurs s'arrêtent, frissonnent, puis repartent vers leur refuge.",
          highlight: null
        }
      ]
    },

    'gn': {
      label: 'GN',
      ipa: '/ɲ/',
      category: 'consonnes',
      description: 'Consonne nasale palatale. Comme "ny" en espagnol (mañana). La langue touche le palais.',
      graphies: ['gn'],
      exemples: ['agneau', 'montagne', 'ligne', 'vigne', 'cigogne'],
      practiceWords: [
        ['montagne', '/mɔ̃taɲ/'],
        ['agneau', '/aɲo/'],
        ['ligne', '/liɲ/'],
        ['vigne', '/viɲ/'],
        ['champignon', '/ʃɑ̃piɲɔ̃/']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'gn_p1',
          text: "Dans la montagne, une cigogne survole les vignes. L'agneau broute paisiblement sur la ligne de crête. Les paysans travaillent dans la campagne baignée de soleil.",
          highlight: null
        },
        {
          id: 'gn_p2',
          text: "La campagne espagnole ressemble à la Bourgogne. Les vignerons s'y connaissent en élagage. On y sert des champignons sauvages cueillis chaque matin dans les sous-bois.",
          highlight: null
        },
        {
          id: 'gn_p3',
          text: "Agnès s'est blessée en descendant la montagne. Heureusement, un chirurgien se trouvait dans le groupe. Avec beaucoup de soin, il a soigné la plaie sur le sentier.",
          highlight: null
        },
        {
          id: 'gn_p4',
          text: "La compagnie théâtrale part en tournée dans la région. Chaque soir, une nouvelle scène dans un village de montagne. Les spectateurs applaudissent avec enthousiasme.",
          highlight: null
        },
        {
          id: 'gn_p5',
          text: "Le vigneron enseigne son savoir-faire à son fils. Il lui montre comment soigner les vignes, taille après taille, ligne après ligne. C'est un héritage précieux à transmettre.",
          highlight: null
        }
      ]
    },

    'ill': {
      label: 'ILL / -IL',
      ipa: '/j/',
      category: 'consonnes',
      description: 'La suite -ill- ou -il final se prononce /j/ (consonne), pas /il/.',
      graphies: ['-ill-', '-il (final)', '-ille'],
      exemples: ['fille', 'famille', 'travail', 'mille', 'briller'],
      practiceWords: [
        ['famille', '/famij/'],
        ['fille', '/fij/'],
        ['travail', '/tʁavaj/'],
        ['briller', '/bʁije/'],
        ['mille', '/mil/']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'ill_p1',
          text: "La fille de la famille brille dans ses travaux. Elle travaille tous les jours avec une volonté remarquable. Son détail préféré : elle chante en taillant ses crayons.",
          highlight: null
        },
        {
          id: 'ill_p2',
          text: "Ce vieux village a beaucoup de charme. Ses ruelles pavées brillent sous la pluie. Les familles se rassemblent sur la place pour y passer de belles veillées ensemble.",
          highlight: null
        },
        {
          id: 'ill_p3',
          text: "Camille veut travailler dans le théâtre. Elle prend des cours tous les jeudis soir et peaufine son travail avec passion. Sa famille la soutient entièrement dans ce projet.",
          highlight: null
        },
        {
          id: 'ill_p4',
          text: "Le soleil brille sur la Bastille. Des milliers de gens défilent ce matin. Les drapeaux qui scintillent dans le vent forment un tableau vivant et magnifique.",
          highlight: null
        },
        {
          id: 'ill_p5',
          text: "Il fouille dans les détails avec minutie. Ce travail de tailleur demande des milliers d'heures d'attention. Mais le résultat final brille d'un éclat unique.",
          highlight: null
        }
      ]
    },

    // ── LIAISON ───────────────────────────────────────────────
    'liaison_obligatoire': {
      label: 'Liaison obligatoire',
      ipa: '/z/, /n/, /t/...',
      category: 'liaison',
      description: 'Certaines liaisons sont obligatoires : après articles, pronoms sujets, adjectifs devant nom.',
      graphies: ['les enfants', 'nous avons', 'petit_ami'],
      exemples: ['les enfants', 'nous avons', 'ils ont', 'un ami', 'très utile'],
      practiceWords: [
        ['les enfants', '/lezɑ̃fɑ̃/'],
        ['nous avons', '/nuzavɔ̃/'],
        ['ils ont', '/ilzɔ̃/'],
        ['un ami', '/œ̃nami/'],
        ['très utile', '/tʁezytil/']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'lo_p1',
          text: "Les enfants ont un ami imaginaire. Ils ont inventé un grand univers ensemble. C'est très amusant et incroyablement utile pour leur imagination.",
          highlight: null
        },
        {
          id: 'lo_p2',
          text: "Nous avons eu un petit accident hier. Ils ont appelé les urgences immédiatement. Heureusement, tout s'est bien terminé. Les enfants ont été très courageux.",
          highlight: null
        },
        {
          id: 'lo_p3',
          text: "C'est un endroit très agréable. Les autres invités ont été très aimables. Nous avons passé un excellent moment ensemble. Ils ont tous adoré les activités.",
          highlight: null
        },
        {
          id: 'lo_p4',
          text: "Vous avez vu ses dernières œuvres? Ils ont exposé les tableaux en octobre. C'est vraiment un artiste exceptionnel et très original dans ses compositions.",
          highlight: null
        },
        {
          id: 'lo_p5',
          text: "Ils ont organisé un événement pour les habitants. C'était très impressionnant et très bien préparé. Les enfants et les adultes ont participé avec enthousiasme.",
          highlight: null
        }
      ]
    },

    'liaison_consonantique': {
      label: 'Consonnes de liaison',
      ipa: '/z/, /n/, /t/, /ʁ/',
      category: 'liaison',
      description: 'Les consonnes finales muettes deviennent audibles devant une voyelle : les_z_enfants.',
      graphies: ['-s (liaison /z/)', '-n (liaison /n/)', '-d (liaison /t/)', '-r'],
      exemples: ['un_ami', 'grand_ami', 'premier_étage', 'ils_ont', 'en_avion'],
      practiceWords: [
        ['un ami', '/œ̃nami/'],
        ['grand ami', '/ɡʁɑ̃tami/'],
        ['en avion', '/ɑ̃navjɔ̃/'],
        ['ils arrivent', '/ilzaʁiv/'],
        ['mon oncle', '/mɔ̃nɔ̃kl/']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'lc_p1',
          text: "Un ami est arrivé en avion. Il habite au premier étage d'un immeuble ancien. C'est un homme intelligent et ouvert d'esprit, toujours en accord avec lui-même.",
          highlight: null
        },
        {
          id: 'lc_p2',
          text: "Mon grand ami est un artiste accompli. Il vit en appartement, dans un endroit calme et ensoleillé. Il peint en écoutant de la musique, sans jamais s'arrêter.",
          highlight: null
        },
        {
          id: 'lc_p3',
          text: "Ils arrivent en été, toujours en avance. C'est un aspect admirable. Quand ils entrent, ils apportent une atmosphère positive et une énergie irrésistible.",
          highlight: null
        },
        {
          id: 'lc_p4',
          text: "En automne, les arbres ont un aspect magnifique. Sous un ancien chêne, deux amis assis discutent en souriant. C'est un instant précieux, un souvenir inestimable.",
          highlight: null
        },
        {
          id: 'lc_p5',
          text: "Les derniers étudiants arrivent en ordre. Ils entrent en silence et s'installent. C'est un examen important et chacun est en état de concentration intense.",
          highlight: null
        }
      ]
    },

    'enchainement': {
      label: 'Enchaînement',
      ipa: '(resyllabation)',
      category: 'liaison',
      description: 'Une consonne finale prononcée s\'enchaîne avec la voyelle initiale du mot suivant : elle_arrive = /ɛlaʁiv/.',
      graphies: ['elle arrive', 'notre ami', 'une idée'],
      exemples: ['elle arrive', 'notre ami', 'une idée', 'il entre', 'avec eux'],
      practiceWords: [
        ['elle arrive', '/ɛlaʁiv/'],
        ['il entre', '/ilɑ̃tʁ/'],
        ['avec eux', '/avɛkø/'],
        ['notre ami', '/nɔtʁami/'],
        ['une idée', '/ynide/']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'ench_p1',
          text: "Elle arrive à l'improviste. Notre ami entre aussitôt et propose une idée originale. Il ouvre une bouteille et offre à chacun un verre. Avec eux, tout devient une fête.",
          highlight: null
        },
        {
          id: 'ench_p2',
          text: "Il entre dans l'atelier avec une énergie débordante. Notre amie apporte une idée nouvelle chaque matin. Avec eux, on apprend autant qu'on enseigne.",
          highlight: null
        },
        {
          id: 'ench_p3',
          text: "Avec elle, il est impossible d'avoir une idée ordinaire. Elle entre dans une pièce et tout s'illumine. Notre équipe adore travailler avec elle, sans aucune exception.",
          highlight: null
        },
        {
          id: 'ench_p4',
          text: "Notre oncle arrive en autobus. Il entre, embrasse tout le monde, et ouvre aussitôt une boîte de chocolats. Avec lui, on oublie les soucis et on rit ensemble.",
          highlight: null
        },
        {
          id: 'ench_p5',
          text: "Elle ouvre une enveloppe avec impatience. Notre amie attend une offre d'emploi. Il entre à ce moment précis et lui annonce une excellente nouvelle. Elle est aux anges.",
          highlight: null
        }
      ]
    },

    // ── RYTHME ────────────────────────────────────────────────
    'accent_tonique': {
      label: 'Accent tonique',
      ipa: "accent sur la dernière syllabe",
      category: 'rythme',
      description: 'En français, l\'accent tombe toujours sur la DERNIÈRE syllabe d\'un groupe rythmique — jamais ailleurs.',
      graphies: ['Groupe de souffle → dernière syllabe accentuée'],
      exemples: ['bonjour', 'la maison', 'je voudrais', 'la belle maison', 'il fait beau'],
      practiceWords: [
        ['bonjour', '/bɔ̃ʒuʁ/'],
        ['la maison', '/lamɛzɔ̃/'],
        ['je voudrais', '/ʒəvudʁɛ/'],
        ['il fait beau', '/ilfɛbo/'],
        ['au revoir', '/oʁəvwaʁ/']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'at_p1',
          text: "Bonjour, je voudrais un café. La belle maison au coin de la rue me plaît beaucoup. Il fait beau aujourd'hui. C'est vraiment une journée parfaite.",
          highlight: null
        },
        {
          id: 'at_p2',
          text: "Permettez-moi de me présenter. Je m'appelle Isabelle. Je travaille dans la communication. J'habite à Montréal depuis trois ans maintenant.",
          highlight: null
        },
        {
          id: 'at_p3',
          text: "Pour commencer, parlons un peu de rythme. En français, chaque groupe se termine par une syllabe forte. Entraînez-vous à sentir cette pulsation régulière.",
          highlight: null
        },
        {
          id: 'at_p4',
          text: "Il n'est pas difficile de progresser si on pratique chaque jour. La clé, c'est la régularité. N'hésitez pas à parler fort et à exagérer au début.",
          highlight: null
        },
        {
          id: 'at_p5',
          text: "La poésie française repose sur ce rythme particulier. Chaque vers se termine sur une syllabe accentuée. C'est ce qui donne au français sa musicalité distincte.",
          highlight: null
        }
      ]
    },

    'intonation_question': {
      label: 'Intonation — Questions',
      ipa: '↗ / ↘',
      category: 'rythme',
      description: 'Les questions totales (oui/non) montent ↗. Les questions partielles (qui, quoi, où...) descendent ↘.',
      graphies: ['Est-ce que... ↗', 'Tu viens? ↗', 'Où vas-tu? ↘'],
      exemples: ['Tu viens?', 'C\'est vrai?', 'Où habites-tu?', 'Qu\'est-ce que tu fais?', 'Il est là?'],
      practiceWords: [
        ['tu viens', '/tyvjɛ̃/ ↗'],
        ['c\'est vrai', '/sɛvʁɛ/ ↗'],
        ['où vas-tu', '/uvaty/ ↘'],
        ['il est là', '/ilɛla/ ↗'],
        ['qu\'est-ce que', '/kɛskə/ ↘']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'iq_p1',
          text: "Tu viens? Il est là? C'est vrai? Où habites-tu? Qu'est-ce que tu fais ce soir? Est-ce que tu as faim? Veux-tu un café? Comment tu t'appelles?",
          highlight: null
        },
        {
          id: 'iq_p2',
          text: "Est-ce que vous parlez français? Vous êtes d'où? Qu'est-ce que vous faites dans la vie? Vous aimez le cinéma? Quel est votre film préféré?",
          highlight: null
        },
        {
          id: 'iq_p3',
          text: "Il fait beau? Tu as vu ce film? C'était bien? Qu'est-ce qui t'a plu? Où est-ce que tu veux aller ensuite? On se retrouve quand?",
          highlight: null
        },
        {
          id: 'iq_p4',
          text: "Tu travailles demain? À quelle heure tu commences? C'est loin de chez toi? Est-ce que tu prends le métro? Tu as besoin d'un lift?",
          highlight: null
        },
        {
          id: 'iq_p5',
          text: "Ça va? Tu as bien dormi? Tu as mangé? Qu'est-ce que tu veux faire aujourd'hui? C'est une belle journée, non? On sort dehors?",
          highlight: null
        }
      ]
    },

    'groupes_rythmiques': {
      label: 'Groupes rythmiques',
      ipa: '[ groupes ] [ de ] [ souffle ]',
      category: 'rythme',
      description: 'Le français se découpe en groupes rhythmiques, chaque groupe formant une unité de sens avec un accent final.',
      graphies: ['[la belle] [maison blanche]', '[je voudrais] [un café] [s\'il vous plaît]'],
      exemples: ['la belle maison', 'je voudrais partir', 'il fait très beau', 'nous allons au marché', 'c\'est une belle journée'],
      practiceWords: [
        ['je voudrais partir', '/ʒəvudʁɛpaʁtiʁ/'],
        ['la belle maison', '/labɛlmɛzɔ̃/'],
        ['il fait très beau', '/ilfɛtʁɛbo/'],
        ['nous allons au marché', '/nuzalɔ̃omaʁʃe/'],
        ['c\'est une belle journée', '/sɛtynbɛlʒuʁne/']
      ],
      confusedWith: [],
      passages: [
        {
          id: 'gr_p1',
          text: "Je voudrais partir tôt ce matin. Il fait très beau et nous allons au marché. C'est une belle journée pour se promener en famille et profiter du soleil.",
          highlight: null
        },
        {
          id: 'gr_p2',
          text: "La belle maison blanche est au bout de l'allée. On y accède par un petit chemin bordé de fleurs. C'est un endroit calme et reposant, loin du bruit de la ville.",
          highlight: null
        },
        {
          id: 'gr_p3',
          text: "Pour bien parler français, il faut respirer au bon endroit. Chaque groupe forme une unité. On ne coupe pas au milieu d'un groupe de sens, c'est la règle fondamentale.",
          highlight: null
        },
        {
          id: 'gr_p4',
          text: "Il est parti très tôt ce matin-là. La route était encore vide et silencieuse. Il a roulé longtemps avant d'arriver à destination. C'était un voyage magnifique.",
          highlight: null
        },
        {
          id: 'gr_p5',
          text: "Nous avons décidé de tout recommencer depuis le début. C'était difficile, mais nécessaire. Maintenant, nous sommes prêts à avancer avec plus de clarté et de sérénité.",
          highlight: null
        }
      ]
    }
  }
};

  </script>
  <script>
// ============================================================
// PHONÉTIQUE APP — CORE APP LOGIC
// ============================================================

const App = {
  currentScreen: 'home',
  currentCategory: null,
  currentPhoneme: null,
  currentMode: null,
  currentPassageIndex: 0,
  settings: {
    darkMode: true,
    frVariant: 'fr-CA',
    openrouterKey: '',
    openrouterModel: 'openai/gpt-4o-mini',
    azureKey: '',
    azureRegion: 'eastus',
    speechSynthVoice: null,
  },
  scores: {},
  recording: false,
  mediaRecorder: null,
  audioChunks: [],
  recordingAudioBlob: null,
  ttsAudio: null,
  generatedPassages: {},
  phonemeShades: {}, // cache of phonemeId → {color, accent}
  bilanPassage: null,
  passageScores: {},   // phonemeId_passageIdx → best score
  bilanScores: {},      // phonemeId → latest diagnostic score
  bilanBestScores: {},  // phonemeId → all-time best diagnostic score
  phraseLibreText: '',

  init() {
    this.loadSettings();
    this.loadScores();
    this.loadDiagScores();
    this.loadPassageScores();
    this.applyTheme();
    this.renderHome();
    this.setupSpeechSynthVoices();
  },

  // ── SETTINGS ────────────────────────────────────────────────
  loadSettings() {
    try {
      const s = localStorage.getItem('phonetique_settings');
      if (s) this.settings = { ...this.settings, ...JSON.parse(s) };
    } catch (e) {}
  },
  saveSettings() {
    localStorage.setItem('phonetique_settings', JSON.stringify(this.settings));
  },
  loadScores() {
    try {
      const s = localStorage.getItem('phonetique_scores');
      if (s) this.scores = JSON.parse(s);
    } catch (e) {}
  },
  saveScores() {
    localStorage.setItem('phonetique_scores', JSON.stringify(this.scores));
  },
  loadDiagScores() {
    try {
      const b = localStorage.getItem('phonetique_bilan');
      if (b) { const d = JSON.parse(b); this.bilanScores = d.latest || {}; this.bilanBestScores = d.best || {}; this.bilanPassage = d.passage || null; }
    } catch(e) {}
  },
  saveDiagScores() {
    localStorage.setItem('phonetique_bilan', JSON.stringify({ latest: this.bilanScores, best: this.bilanBestScores, passage: this.bilanPassage }));
  },
  loadPassageScores() {
    try {
      const s = localStorage.getItem('phonetique_passage_scores');
      if (s) this.passageScores = JSON.parse(s);
    } catch(e) {}
  },
  savePassageScores() {
    localStorage.setItem('phonetique_passage_scores', JSON.stringify(this.passageScores));
  },
  getPassageScore(phonemeId, idx) {
    return this.passageScores[phonemeId + '_' + idx] ?? null;
  },
  recordPassageScore(phonemeId, idx, score) {
    const key = phonemeId + '_' + idx;
    // Keep best score for each passage
    if (this.passageScores[key] === undefined || score > this.passageScores[key]) {
      this.passageScores[key] = score;
      this.savePassageScores();
    }
  },
  applyTheme() {
    document.documentElement.setAttribute('data-theme', this.settings.darkMode ? 'dark' : 'light');
  },

  // ── NAVIGATION ──────────────────────────────────────────────
  navigate(screen, params = {}) {
    this.currentScreen = screen;
    const main = document.getElementById('main');
    main.classList.add('screen-exit');
    setTimeout(() => {
      main.classList.remove('screen-exit');
      main.classList.add('screen-enter');
      switch (screen) {
        case 'home': this.renderHome(); break;
        case 'category': this.renderCategory(params.categoryId); break;
        case 'phoneme': this.renderPhoneme(params.phonemeId); break;
        case 'mode-practice': this.renderPractice(params.phonemeId); break;
        case 'mode-read': this.renderRead(params.phonemeId, params.passageIndex || 0); break;
        case 'mode-compare': this.renderCompare(params.phonemeId); break;
        case 'mode-test': this.renderTest(params.phonemeId); break;
        case 'scores': this.renderScores(); break;
        case 'phrase-libre': this.renderPhraseLibre(); break;
        case 'bilan': this.renderBilan(); break;
        case 'labo': this.renderLabo(); break;
        case 'labo-scores': this.renderLaboScores(); break;
        case 'settings': this.renderSettings(); break;
      }
      setTimeout(() => main.classList.remove('screen-enter'), 400);
    }, 150);
  },

  // ── HOME ────────────────────────────────────────────────────
  renderHome() {
    const cats = APP_DATA.categories;
    document.getElementById('main').innerHTML = `
      <div class="home-header">
        <div class="app-logo">
          <div class="logo-full"><span class="logo-ph">Pho</span><span class="logo-onetique">nétique</span></div>
          <div class="logo-tagline">Maîtrisez les sons du français</div>
        </div>
        <div class="header-actions">
          <button class="icon-btn labo-btn" onclick="App.navigate('labo')" title="Le Labo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 3h6v10l3.5 6a1 1 0 0 1-.9 1.5H6.4a1 1 0 0 1-.9-1.5L9 13V3z"/>
              <path d="M6.5 17.5 c1-1 2 .5 3 0 s2-1 3 0"/>
              <line x1="9" y1="3" x2="15" y2="3"/>
            </svg>
          </button>
          <button class="icon-btn" onclick="App.navigate('scores')" title="Scores">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </button>
          <button class="icon-btn" onclick="App.navigate('settings')" title="Paramètres">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          </button>
        </div>
      </div>
      <div class="category-grid">
        ${cats.map(c => `
          <button class="category-tile" style="--cat-color:${c.color};--cat-accent:${c.accent}" onclick="App.navigate('category', {categoryId:'${c.id}'})">
            <div class="cat-icon">${c.icon}</div>
            <div class="cat-label">${c.label}</div>
            <div class="cat-desc">${c.description}</div>
            <div class="cat-glow"></div>
          </button>
        `).join('')}
      </div>
    `;
  },

  renderLabo() {
    const hasKey = !!this.settings.openrouterKey;
    document.getElementById('main').innerHTML = `
      <div class="home-header labo-header">
        <div class="app-logo">
          <div class="logo-full labo-logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="labo-logo-icon">
              <path d="M9 3h6v10l3.5 6a1 1 0 0 1-.9 1.5H6.4a1 1 0 0 1-.9-1.5L9 13V3z"/>
              <path d="M6.5 17.5 c1-1 2 .5 3 0 s2-1 3 0"/>
              <line x1="9" y1="3" x2="15" y2="3"/>
            </svg>
            <span class="labo-title">Le Labo</span>
          </div>
          <div class="logo-tagline labo-tagline">Fonctions expérimentales</div>
        </div>
        <div class="header-actions">
          <button class="icon-btn labo-home-btn" onclick="App.navigate('home')" title="Accueil">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </button>
          <button class="icon-btn labo-scores-btn" onclick="App.navigate('labo-scores')" title="Scores Labo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </button>
          <button class="icon-btn" onclick="App.navigate('settings')" title="Paramètres">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          </button>
        </div>
      </div>
      <div class="category-grid labo-grid">
        <button class="category-tile labo-tile" style="--cat-color:#003D38;--cat-accent:#00F5D4" onclick="App.navigate('phrase-libre')">
          <div class="cat-icon">✏️</div>
          <div class="cat-label">Phrase libre</div>
          <div class="cat-desc">Prononcez votre propre phrase</div>
          <div class="cat-glow"></div>
        </button>
        <button class="category-tile labo-tile ${hasKey ? '' : 'tile-locked'}"
          style="--cat-color:#003330;--cat-accent:#2DD4BF"
          onclick="${hasKey ? "App.navigate('bilan')" : 'App.showNoKeyMsg()'}">
          <div class="cat-icon">${hasKey ? '🔬' : '🔒'}</div>
          <div class="cat-label">Bilan</div>
          <div class="cat-desc">${hasKey ? 'Diagnostic de tous vos sons' : 'Requiert une clé OpenRouter'}</div>
          <div class="cat-glow"></div>
        </button>
        <button class="category-tile labo-tile labo-coming-soon" style="--cat-color:#002A28;--cat-accent:#14B8A6" disabled>
          <div class="cat-icon">🎯</div>
          <div class="cat-label">Défi du jour</div>
          <div class="cat-desc">Bientôt disponible</div>
          <div class="labo-coming-badge">Bientôt</div>
          <div class="cat-glow"></div>
        </button>
        <button class="category-tile labo-tile labo-coming-soon" style="--cat-color:#002220;--cat-accent:#0D9488" disabled>
          <div class="cat-icon">📊</div>
          <div class="cat-label">Comparaison</div>
          <div class="cat-desc">Comparez vos enregistrements</div>
          <div class="labo-coming-badge">Bientôt</div>
          <div class="cat-glow"></div>
        </button>
        <button class="category-tile labo-tile labo-coming-soon" style="--cat-color:#001A18;--cat-accent:#0F766E" disabled>
          <div class="cat-icon">🗣️</div>
          <div class="cat-label">Conversation IA</div>
          <div class="cat-desc">Pratiquez en dialoguant</div>
          <div class="labo-coming-badge">Bientôt</div>
          <div class="cat-glow"></div>
        </button>
        <button class="category-tile labo-tile labo-coming-soon" style="--cat-color:#001210;--cat-accent:#115E59" disabled>
          <div class="cat-icon">🎵</div>
          <div class="cat-label">Chanson</div>
          <div class="cat-desc">Apprenez par la musique</div>
          <div class="labo-coming-badge">Bientôt</div>
          <div class="cat-glow"></div>
        </button>
      </div>
    `;
  },

  showNoKeyMsg() {
    const old = document.getElementById('toastMsg');
    if (old) old.remove();
    const msg = document.createElement('div');
    msg.id = 'toastMsg';
    msg.className = 'toast-msg';
    msg.textContent = 'Ajoutez une clé OpenRouter dans les Paramètres pour accéder au Bilan.';
    msg.style.borderColor = 'rgba(0,245,212,0.4)';
    document.body.appendChild(msg);
    setTimeout(() => msg.classList.add('toast-show'), 10);
    setTimeout(() => { msg.classList.remove('toast-show'); setTimeout(() => msg.remove(), 400); }, 3200);
  },

  // ── CATEGORY ────────────────────────────────────────────────
  renderCategory(categoryId) {
    this.currentCategory = categoryId;
    const cat = APP_DATA.categories.find(c => c.id === categoryId);
    const phonemes = cat.phonemes.map(id => ({ id, ...APP_DATA.phonemes[id] }));
    // Generate distinct shades for each phoneme tile based on category hue
    const shades = this.generatePhonemeShades(cat.color, cat.accent, phonemes.length);
    // Cache shades so other screens can look them up by phonemeId
    phonemes.forEach((p, i) => { this.phonemeShades[p.id] = shades[i]; });
    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')">
          <span class="logo-ph">Ph</span><span class="logo-onetique">o</span>
        </button>
        <div class="screen-title" style="color:${cat.accent}">${cat.label}</div>
      </div>
      <div class="phoneme-grid">
        ${phonemes.map((p, i) => {
          const score = this.getPhonemeScore(p.id);
          const scoreHtml = score !== null ? `<div class="phoneme-score" style="color:${this.scoreColor(score)}">${score}%</div>` : '';
          const shade = shades[i];
          return `
            <button class="phoneme-tile" style="--cat-color:${shade.color};--cat-accent:${shade.accent}" onclick="App.navigate('phoneme', {phonemeId:'${p.id}'})">
              <div class="phoneme-ipa">${p.ipa}</div>
              <div class="phoneme-label">${p.label}</div>
              <div class="phoneme-examples">${p.exemples.slice(0,3).join(' · ')}</div>
              ${scoreHtml}
            </button>
          `;
        }).join('')}
      </div>
    `;
  },

  // ── PHONEME PAGE ─────────────────────────────────────────────
  renderPhoneme(phonemeId) {
    this.currentPhoneme = phonemeId;
    const p = APP_DATA.phonemes[phonemeId];
    const cat = APP_DATA.categories.find(c => c.id === p.category);
    const shade = this.getPhonemeShade(phonemeId);
    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')">
          <span class="logo-ph">Ph</span><span class="logo-onetique">o</span>
        </button>
        <button class="back-btn" onclick="App.navigate('category', {categoryId:'${p.category}'})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="screen-title" style="color:${shade.accent}">${p.label}</div>
      </div>
      <div class="phoneme-hero">
        <div class="phoneme-hero-ipa" style="color:${shade.accent}">${p.ipa}</div>
        <div class="phoneme-hero-label">${p.label}</div>
        <div class="phoneme-hero-desc">${p.description}</div>
        <div class="phoneme-hero-graphies">
          ${p.graphies.map(g => `<span class="graphie-tag">${g}</span>`).join('')}
        </div>
      </div>
      <div class="mode-grid">
        <button class="mode-tile mode-practice" onclick="App.navigate('mode-practice', {phonemeId:'${phonemeId}'})">
          <div class="mode-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
          </div>
          <div class="mode-label">Pratiquer</div>
          <div class="mode-sub">Écoute & prononce le son</div>
        </button>
        <button class="mode-tile mode-read" onclick="App.navigate('mode-read', {phonemeId:'${phonemeId}', passageIndex:0})">
          <div class="mode-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          </div>
          <div class="mode-label">Lire & Écouter</div>
          <div class="mode-sub">Passages avec ce son</div>
        </button>
        <button class="mode-tile mode-compare" onclick="App.navigate('mode-compare', {phonemeId:'${phonemeId}'})">
          <div class="mode-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          </div>
          <div class="mode-label">Comparer</div>
          <div class="mode-sub">Sons similaires côte à côte</div>
        </button>
        <button class="mode-tile mode-test" onclick="App.navigate('mode-test', {phonemeId:'${phonemeId}'})">
          <div class="mode-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          </div>
          <div class="mode-label">Tester</div>
          <div class="mode-sub">Évalue ta prononciation</div>
        </button>
      </div>
    `;
  },

  // ── PRACTICE MODE ────────────────────────────────────────────
  renderPractice(phonemeId) {
    this.currentPhoneme = phonemeId;
    const p = APP_DATA.phonemes[phonemeId];
    const cat = APP_DATA.categories.find(c => c.id === p.category);
    const shade = this.getPhonemeShade(phonemeId);
    this.currentPracticeWordIndex = 0;
    const words = p.practiceWords;
    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')"><span class="logo-ph">Ph</span><span class="logo-onetique">o</span></button>
        <button class="back-btn" onclick="App.navigate('phoneme', {phonemeId:'${phonemeId}'})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="screen-title" style="color:${shade.accent}">Pratiquer</div>
      </div>
      <div class="practice-container">
        <div class="practice-sound-card" style="--cat-color:${shade.color};--cat-accent:${shade.accent}">
          <div class="practice-ipa">${p.ipa}</div>

          <div class="word-carousel" id="wordCarousel">
            <button class="carousel-arrow carousel-prev" onclick="App.prevWord('${phonemeId}')" style="color:${shade.accent}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
            <div class="carousel-center">
              <div class="carousel-word-wrap" id="carouselWordWrap">
                <div class="practice-word" id="practiceWord">${words[0][0]}</div>
                <div class="practice-word-ipa" id="practiceWordIpa">${words[0][1]}</div>
              </div>
              <div class="carousel-dots">
                ${words.map((_,i) => {
                  const isActive = i === 0;
                  return '<button class="carousel-num-btn' + (isActive ? ' active' : '') + '" style="background:' + (isActive ? shade.accent : 'transparent') + ';border-color:' + shade.accent + ';color:' + (isActive ? '#000' : shade.accent) + '" onclick="App.goToWord(\'' + phonemeId + '\', ' + i + ')">' + (i+1) + '</button>';
                }).join('')}
              </div>
            </div>
            <button class="carousel-arrow carousel-next" onclick="App.nextWord('${phonemeId}')" style="color:${shade.accent}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
          </div>

          <button class="listen-btn" id="listenBtn" onclick="App.speakCurrentWord()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
            Écouter
          </button>
        </div>
        <div class="practice-tips">
          <div class="tip-title">Comment prononcer :</div>
          <div class="tip-text">${p.description}</div>
          <div class="tip-graphies">
            ${p.graphies.map(g => `<span class="graphie-tag">${g}</span>`).join('')}
          </div>
        </div>
        <div class="record-section">
          <button class="record-btn" id="recordBtn" onclick="App.toggleRecording('${phonemeId}', 'practice')">
            <div class="record-btn-inner">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
            </div>
            <div class="record-label">Appuyer pour enregistrer</div>
          </button>
          <div id="recordingStatus" class="recording-status hidden"></div>
          <div id="playbackArea" class="playback-area hidden">
            <button class="playback-btn" id="playbackBtn" onclick="App.playRecording()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Réécouter
            </button>
          </div>
          <div id="scoreArea" class="score-area hidden"></div>
        </div>
      </div>
    `;
  },

  // ── READ MODE ────────────────────────────────────────────────
  renderRead(phonemeId, passageIndex) {
    this.currentPhoneme = phonemeId;
    this.currentPassageIndex = passageIndex;
    const p = APP_DATA.phonemes[phonemeId];
    const shade = this.getPhonemeShade(phonemeId);
    const passages = this.getPassages(phonemeId);
    const passage = passages[passageIndex];
    const total = passages.length;
    const MAX_PASSAGES = 10; // 5 fixed + 5 AI bonus
    const BASE_PASSAGES = 5;
    const canAddMore = this.settings.openrouterKey && total < MAX_PASSAGES;
    const isBonus = passageIndex >= BASE_PASSAGES;

    // Per-passage record score
    // Record score is shown in the score display after recording (not above the card)
    const bestScoreHtml = '';

    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')"><span class="logo-ph">Ph</span><span class="logo-onetique">o</span></button>
        <button class="back-btn" onclick="App.navigate('phoneme', {phonemeId:'${phonemeId}'})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="screen-title" style="color:${shade.accent}">Lire & Écouter</div>
      </div>
      <div class="read-container">

        <!-- Passage number pill carousel (shows 5 at a time, centred on current) -->
        <div class="read-num-strip">
          ${(() => {
            const showCount = 5;
            const half = Math.floor(showCount / 2);
            // Build the visible slot indices: centre on passageIndex, clamp to available
            const allSlots = [...Array(total).keys()];
            if (canAddMore) allSlots.push('add');
            const totalSlots = allSlots.length;
            let centre = Math.max(half, Math.min(passageIndex, totalSlots - 1 - half));
            const visible = allSlots.slice(Math.max(0, centre - half), centre - half + showCount);
            return visible.map(slot => {
              if (slot === 'add') return `<button class="pnum-btn pnum-add" onclick="App.addBonusPassage('${phonemeId}')">+</button>`;
              const isActive = slot === passageIndex;
              const isBonus2 = slot >= BASE_PASSAGES;
              const accent = isBonus2 ? '#F59E0B' : shade.accent;
              const size = isActive ? '32px' : '26px';
              const fontSize = isActive ? '13px' : '11px';
              const bg = isActive ? accent : 'transparent';
              const col = isActive ? (isBonus2 ? '#000' : '#000') : accent;
              return `<button class="pnum-btn ${isActive ? 'pnum-active' : ''}"
                style="width:${size};height:${size};font-size:${fontSize};background:${bg};border-color:${accent};color:${col}"
                onclick="App.navigate('mode-read',{phonemeId:'${phonemeId}',passageIndex:${slot}})">${slot + 1}</button>`;
            }).join('');
          })()}
        </div>

        ${bestScoreHtml}

        <!-- Passage card with integrated chevrons and swipe -->
        <div class="read-passage-wrap"
          id="readPassageWrap"
          data-phoneme="${phonemeId}"
          data-idx="${passageIndex}"
          data-total="${total}"
          data-canadd="${canAddMore}">
          <button class="read-chev read-chev-l ${passageIndex === 0 ? 'invisible' : ''}"
            onclick="App.navigate('mode-read',{phonemeId:'${phonemeId}',passageIndex:${passageIndex - 1}})"
            style="color:${shade.accent}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
          </button>

          <div class="passage-card ${isBonus ? 'bonus-passage' : ''}" style="--cat-color:${shade.color};--cat-accent:${shade.accent}">
            ${isBonus ? `<div class="bonus-badge">✨ Bonus ${passageIndex - BASE_PASSAGES + 1}/5</div>` : ''}
            <div class="passage-text" id="passageText">${this.highlightPassage(passage.text, phonemeId)}</div>
            <div class="passage-actions">
              <button class="passage-listen-btn" onclick="App.speakCurrentPassage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
              </button>
              ${(this.settings.openrouterKey && isBonus) ? `
              <button class="generate-btn" onclick="App.generateNewPassage('${phonemeId}', ${passageIndex})" title="Régénérer">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
              </button>` : ''}
            </div>
          </div>

          <button class="read-chev read-chev-r ${passageIndex >= total - 1 && !canAddMore ? 'invisible' : ''}"
            onclick="${passageIndex < total - 1
              ? `App.navigate('mode-read',{phonemeId:'${phonemeId}',passageIndex:${passageIndex + 1}})`
              : `App.addBonusPassage('${phonemeId}')`}"
            style="color:${shade.accent}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
        </div>

        <div class="read-record-section">
          <div class="read-instructions">Lisez ce passage à voix haute — le son cible est <strong style="color:${shade.accent}">${p.ipa}</strong></div>
          <button class="record-btn" id="recordBtn" onclick="App.toggleRecording('${phonemeId}', 'read', ${passageIndex})">
            <div class="record-btn-inner">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
            </div>
            <div class="record-label">Enregistrer ma lecture</div>
          </button>
          <div id="recordingStatus" class="recording-status hidden"></div>
          <div id="playbackArea" class="playback-area hidden">
            <button class="playback-btn" onclick="App.playRecording()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Réécouter
            </button>
          </div>
          <div id="scoreArea" class="score-area hidden"></div>
        </div>
      </div>
    `;
    // Wire up swipe on the passage card
    this._setupPassageSwipe();
  },

  _setupPassageSwipe() {
    const wrap = document.getElementById('readPassageWrap');
    if (!wrap) return;
    let startX = 0, startY = 0;
    wrap.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    }, { passive: true });
    wrap.addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - startX;
      const dy = e.changedTouches[0].clientY - startY;
      if (Math.abs(dx) < 40 || Math.abs(dy) > Math.abs(dx)) return; // not a horizontal swipe
      const phonemeId = wrap.dataset.phoneme;
      const idx = parseInt(wrap.dataset.idx);
      const total = parseInt(wrap.dataset.total);
      const canAdd = wrap.dataset.canadd === 'true';
      if (dx < 0) {
        // swipe left → next
        if (idx < total - 1) App.navigate('mode-read', { phonemeId, passageIndex: idx + 1 });
        else if (canAdd) App.addBonusPassage(phonemeId);
      } else {
        // swipe right → prev
        if (idx > 0) App.navigate('mode-read', { phonemeId, passageIndex: idx - 1 });
      }
    }, { passive: true });
  },

  async addBonusPassage(phonemeId) {
    if (!this.settings.openrouterKey) return;
    const passages = this.getPassages(phonemeId);
    if (passages.length >= 10) { this.showToast('Maximum 10 passages atteint.'); return; }
    const p = APP_DATA.phonemes[phonemeId];
    const newIdx = passages.length;
    // Show generating state immediately
    this.navigate('mode-read', { phonemeId, passageIndex: newIdx - 1 });
    // Generate
    const difficulty = Math.min(newIdx - 3, 5); // bonus passages get harder
    const prompt = "Écris un passage en français de 4 à 6 phrases contenant beaucoup d'exemples du son " + p.ipa + " (" + p.label + "). Les graphies courantes pour ce son incluent : " + p.graphies.join(', ') + ". Difficulté : niveau avancé (vocabulaire riche, phrases complexes). IMPORTANT: texte brut uniquement, sans astérisques ni formatage markdown.";
    try {
      const resp = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + this.settings.openrouterKey, 'Content-Type': 'application/json', 'HTTP-Referer': window.location.href },
        body: JSON.stringify({ model: this.settings.openrouterModel, messages: [{ role: 'user', content: prompt }], max_tokens: 300 }),
      });
      const data = await resp.json();
      const text = data.choices?.[0]?.message?.content?.trim().replace(/\*/g, '');
      if (text) {
        APP_DATA.phonemes[phonemeId].passages.push({ id: phonemeId + '_bonus_' + newIdx, text, generated: true });
        this.navigate('mode-read', { phonemeId, passageIndex: newIdx });
      }
    } catch(e) { console.error('Bonus passage error:', e); }
  },

  // ── COMPARE MODE ─────────────────────────────────────────────
  renderCompare(phonemeId) {
    const p = APP_DATA.phonemes[phonemeId];
    const cat = APP_DATA.categories.find(c => c.id === p.category);
    const shade = this.getPhonemeShade(phonemeId);
    const confused = (p.confusedWith || []).filter(id => APP_DATA.phonemes[id]);

    let compareHtml = '';
    if (confused.length === 0) {
      compareHtml = `<div class="compare-empty">Ce son n'a pas de confusion typique répertoriée dans l'application. Explorez d'autres sons!</div>`;
    } else {
      compareHtml = `
        <div class="compare-main">
          <div class="compare-card active-card" style="--cat-color:${shade.color};--cat-accent:${shade.accent}">
            <div class="compare-ipa">${p.ipa}</div>
            <div class="compare-label">${p.label}</div>
            <button class="compare-listen" onclick="App.speakText('${p.targetWord}', true)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
              ${p.targetWord}
            </button>
          </div>
          <div class="compare-vs">VS</div>
          ${confused.map(confId => {
            const cp = APP_DATA.phonemes[confId];
            const ccat = APP_DATA.categories.find(c => c.id === cp.category);
            return `
              <div class="compare-card" style="--cat-color:${ccat.color};--cat-accent:${ccat.accent}">
                <div class="compare-ipa">${cp.ipa}</div>
                <div class="compare-label">${cp.label}</div>
                <button class="compare-listen" onclick="App.speakText('${cp.targetWord}', true)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                  ${cp.targetWord}
                </button>
                <button class="compare-goto" onclick="App.navigate('phoneme',{phonemeId:'${confId}'})">
                  Aller à ce son →
                </button>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')"><span class="logo-ph">Ph</span><span class="logo-onetique">o</span></button>
        <button class="back-btn" onclick="App.navigate('phoneme', {phonemeId:'${phonemeId}'})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="screen-title" style="color:${shade.accent}">Comparer</div>
      </div>
      <div class="compare-container">${compareHtml}</div>
    `;
  },

  // ── TEST MODE ────────────────────────────────────────────────
  renderTest(phonemeId) {
    this.currentPhoneme = phonemeId;
    const p = APP_DATA.phonemes[phonemeId];
    const cat = APP_DATA.categories.find(c => c.id === p.category);
    const shade = this.getPhonemeShade(phonemeId);
    const passages = this.getPassages(phonemeId);
    const idx = Math.floor(Math.random() * passages.length);
    const passage = passages[idx];

    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')"><span class="logo-ph">Ph</span><span class="logo-onetique">o</span></button>
        <button class="back-btn" onclick="App.navigate('phoneme', {phonemeId:'${phonemeId}'})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="screen-title" style="color:${shade.accent}">Test</div>
      </div>
      <div class="test-container">
        <div class="test-instructions">
          <div class="test-badge" style="color:${shade.accent}">${p.ipa}</div>
          <p>Lisez ce passage à voix haute. Votre score sera enregistré.</p>
        </div>
        <div class="test-passage-card" style="--cat-color:${shade.color};--cat-accent:${shade.accent}">
          <div class="passage-text">${this.highlightPassage(passage.text, phonemeId)}</div>
        </div>
        <div class="test-record-section">
          <button class="record-btn large-record" id="recordBtn" onclick="App.toggleRecording('${phonemeId}', 'test', ${idx})">
            <div class="record-btn-inner">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
            </div>
            <div class="record-label">Commencer l'enregistrement</div>
          </button>
          <div id="recordingStatus" class="recording-status hidden"></div>
          <div id="playbackArea" class="playback-area hidden">
            <button class="playback-btn" onclick="App.playRecording()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Réécouter
            </button>
          </div>
          <div id="scoreArea" class="score-area hidden"></div>
        </div>
      </div>
    `;
  },

  // ── SCORES ───────────────────────────────────────────────────
  // ── PHRASE LIBRE ─────────────────────────────────────────────
  renderPhraseLibre() {
    const saved = this.phraseLibreText || '';
    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')"><span class="logo-ph">Ph</span><span class="logo-onetique">o</span></button>
        <div class="screen-title" style="color:#48CAE4">Phrase libre</div>
      </div>
      <div class="libre-container">
        <div class="libre-card" style="--cat-color:#0F4C75;--cat-accent:#48CAE4">
          <div class="libre-prompt">Écrivez votre phrase, puis prononcez-la :</div>
          <textarea class="libre-input" id="libreInput" placeholder="Ex: Je voudrais une baguette s'il vous plaît..." maxlength="300">${saved}</textarea>
          <div class="libre-chars"><span id="libreCount">${saved.length}</span>/300</div>
        </div>
        <div class="libre-actions">
          <button class="listen-btn" style="color:#48CAE4;border-color:rgba(72,202,228,0.3);background:rgba(72,202,228,0.1)"
            onclick="App.speakLibreText()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
            Écouter
          </button>
        </div>
        <div class="record-section">
          <button class="record-btn" id="recordBtn" onclick="App.recordLibre()">
            <div class="record-btn-inner" style="background:linear-gradient(135deg,#0F4C75,#48CAE4)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
            </div>
            <div class="record-label">Enregistrer ma prononciation</div>
          </button>
          <div id="recordingStatus" class="recording-status hidden"></div>
          <div id="playbackArea" class="playback-area hidden">
            <button class="playback-btn" onclick="App.playRecording()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Réécouter
            </button>
          </div>
          <div id="scoreArea" class="score-area hidden"></div>
        </div>
      </div>
    `;
    const ta = document.getElementById('libreInput');
    if (ta) {
      ta.addEventListener('input', () => {
        this.phraseLibreText = ta.value;
        const c = document.getElementById('libreCount');
        if (c) c.textContent = ta.value.length;
      });
    }
  },

  speakLibreText() {
    const ta = document.getElementById('libreInput');
    const text = ta ? ta.value.trim() : this.phraseLibreText;
    if (text) this.speakText(text, false);
  },

  recordLibre() {
    const ta = document.getElementById('libreInput');
    const text = ta ? ta.value.trim() : this.phraseLibreText;
    if (!text) {
      alert("Veuillez d'abord écrire une phrase.");
      return;
    }
    this.phraseLibreText = text;
    this.toggleRecording('__libre__', 'libre');
  },

  // ── BILAN ─────────────────────────────────────────────────────
  renderBilan() {
    const hasPassage = !!this.bilanPassage;
    const hasKey = !!this.settings.openrouterKey;
    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')"><span class="logo-ph">Ph</span><span class="logo-onetique">o</span></button>
        <div class="screen-title" style="color:#C084FC">Bilan</div>
      </div>
      <div class="bilan-container">
        <div class="bilan-intro">
          <div class="bilan-icon">🔬</div>
          <p>Un passage couvrant un maximum de sons français. Lisez-le à voix haute pour obtenir un diagnostic de votre prononciation.</p>
          <button class="generate-passage-btn" id="genBtn" onclick="App.generateBilanPassage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 0-2.12-9.36L23 10"/></svg>
            ${hasPassage ? 'Nouveau passage (IA)' : 'Générer un passage (IA)'}
          </button>
        </div>

        ${hasPassage ? `
        <div class="bilan-passage-card" id="bilanPassageCard">
          <div class="passage-text">${this.bilanPassage}</div>
        </div>
        <div class="bilan-tip">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;flex-shrink:0"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Lisez tout le passage d'une traite — l'analyse se fait phrase par phrase automatiquement.
        </div>
        <div class="record-section">
          <button class="record-btn large-record" id="recordBtn" onclick="App.toggleRecording('__bilan__', 'bilan')">
            <div class="record-btn-inner">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
            </div>
            <div class="record-label">Commencer le diagnostic</div>
          </button>
          <div id="recordingStatus" class="recording-status hidden"></div>
          <div id="playbackArea" class="playback-area hidden">
            <button class="playback-btn" onclick="App.playRecording()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Réécouter
            </button>
          </div>
          <div id="scoreArea" class="score-area hidden"></div>
        </div>` : `
        <div class="bilan-empty">
          <p>Appuyez sur <strong>Générer</strong> pour créer votre premier passage de diagnostic.</p>
        </div>`}
      </div>
    `;
  },

  async generateBilanPassage() {
    const btn = document.getElementById('genBtn');
    if (btn) { btn.disabled = true; btn.textContent = 'Génération...'; }
    const prompt = `Écris un passage en français de 3 à 4 phrases courtes (maximum 50 mots au total) conçu pour tester les sons difficiles du français. Inclus naturellement: des voyelles nasales (en/an, in, on), le son U et EU, le R français, et au moins une liaison obligatoire. Le texte doit être simple, cohérent, et facile à lire à voix haute. IMPORTANT: Maximum 50 mots. Réponds avec UNIQUEMENT du texte brut, sans aucun formatage markdown, sans astérisques. Texte simple uniquement.`;
    try {
      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + this.settings.openrouterKey,
          'Content-Type': 'application/json',
          'HTTP-Referer': window.location.href,
        },
        body: JSON.stringify({
          model: this.settings.openrouterModel,
          messages: [{ role: 'user', content: prompt }],
          max_tokens: 300,
        }),
      });
      const data = await response.json();
      const text = data.choices?.[0]?.message?.content?.trim().replace(/\*/g, '').replace(/_{1,2}([^_]+)_{1,2}/g, '$1').trim();
      if (text) {
        this.bilanPassage = text;
        this.saveDiagScores();
        this.renderBilan();
      }
    } catch(e) {
      console.error('Bilan generation error:', e);
      if (btn) { btn.disabled = false; btn.textContent = 'Réessayer'; }
    }
  },

  processBilanResults(words) {
    // Map recognised words back to phoneme categories using graphie matching.
    // We match each word's text against the graphies/exemples of each phoneme,
    // then accumulate its AccuracyScore into that category.
    const catScores = {};
    const catCounts = {};

    // Build a lookup: word (lowercase) → category id
    // from all phoneme exemples and practiceWords
    const wordToCat = {};
    Object.entries(APP_DATA.phonemes).forEach(([id, p]) => {
      const cat = p.category;
      // exemples
      (p.exemples || []).forEach(w => { wordToCat[w.toLowerCase()] = cat; });
      // practiceWords
      (p.practiceWords || []).forEach(([w]) => {
        w.split(/\s+/).forEach(part => { wordToCat[part.toLowerCase()] = cat; });
      });
    });

    // Also do a graphie-based match: if a word contains a graphie, tag it
    const graphieToCat = {};
    Object.entries(APP_DATA.phonemes).forEach(([id, p]) => {
      (p.graphies || []).forEach(g => {
        if (g.length >= 2) graphieToCat[g.toLowerCase()] = p.category;
      });
    });

    words.forEach(w => {
      const wText = (w.Word || '').toLowerCase().replace(/[^a-zàâäéèêëîïôœùûüç]/g, '');
      const acc = w.AccuracyScore ?? 100;
      if (acc === 0 && w.ErrorType === 'Omission') return; // skip truly missed words

      // Try direct word match first
      let cat = wordToCat[wText];

      // Try graphie match
      if (!cat) {
        for (const [g, c] of Object.entries(graphieToCat)) {
          if (wText.includes(g)) { cat = c; break; }
        }
      }

      // Fallback: assign to 'moyennes' (catches most French vowels)
      if (!cat) cat = 'moyennes';

      if (!catScores[cat]) { catScores[cat] = 0; catCounts[cat] = 0; }
      catScores[cat] += acc;
      catCounts[cat]++;
    });

    console.log('Bilan category scores (raw):', catScores, catCounts);

    // Compute remapped scores per category
    // Only update categories that had enough words (≥2) for reliability
    Object.keys(catScores).forEach(cat => {
      if (catCounts[cat] >= 1) {
        const raw = catScores[cat] / catCounts[cat];
        const remapped = Math.round(this.remapScore(raw));
        this.bilanScores[cat] = remapped;
        this.bilanBestScores[cat] = Math.max(remapped, this.bilanBestScores[cat] || 0);
      }
    });

    // If we have an overall score but no category breakdown, store it as overall
    if (Object.keys(catScores).length === 0) {
      // Distribute overall score to all cats as a placeholder
      const overall = words.reduce((s, w) => s + (w.AccuracyScore || 0), 0) / Math.max(1, words.length);
      APP_DATA.categories.forEach(c => {
        this.bilanScores[c.id] = Math.round(this.remapScore(overall));
        this.bilanBestScores[c.id] = Math.max(this.bilanScores[c.id], this.bilanBestScores[c.id] || 0);
      });
    }

    this.saveDiagScores();
    console.log('Bilan scores saved:', this.bilanScores);
  },

  showBilanResults(score, pa, words) {
    this.processBilanResults(words);
    // Store words for the annotation overlay
    this._bilanWords = words;

    const scoreArea = document.getElementById('scoreArea');
    const status = document.getElementById('recordingStatus');
    if (status) status.classList.add('hidden');
    if (!scoreArea) return;
    scoreArea.classList.remove('hidden');
    const color = this.scoreColor(score);

    scoreArea.innerHTML = `
      <div class="score-display">
        <div class="score-ring" style="--score-color:${color}">
          <svg viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
            <circle cx="50" cy="50" r="40" fill="none" stroke="${color}" stroke-width="8"
              stroke-dasharray="${2.51 * score} 251" stroke-linecap="round" transform="rotate(-90 50 50)"/>
          </svg>
          <div class="score-number">${score}<span class="score-pct-sym">%</span></div>
        </div>
        <div class="score-feedback">${this.scoreFeedback(score)}</div>
        <div class="bilan-saved-msg">✓ Scores enregistrés — consultez <strong>Mes Scores</strong>.</div>
        <button class="annotate-btn" onclick="App.toggleBilanAnnotation()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Voir les détails mot par mot
        </button>
      </div>
      <button class="next-btn" onclick="App.navigate('scores')" style="margin-top:8px">Voir le Bilan complet →</button>
      <button class="retry-btn" onclick="App.retryRecording()" style="margin-top:8px">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>
        Réessayer
      </button>
    `;
    const btn = document.getElementById('recordBtn');
    if (btn) { btn.disabled = false; btn.querySelector('.record-label').textContent = 'Recommencer'; }
  },

  toggleBilanAnnotation() {
    const card = document.getElementById('bilanPassageCard');
    if (!card) return;
    const existing = card.querySelector('.annotation-overlay');
    if (existing) { existing.remove(); return; }

    const words = this._bilanWords || [];
    // Build a map of word → score for quick lookup
    const wordScores = {};
    words.forEach(w => {
      const key = (w.Word || '').toLowerCase();
      wordScores[key] = { score: w.AccuracyScore ?? 100, error: w.ErrorType };
    });

    // Annotate the passage text word by word
    const passage = this.bilanPassage || '';
    const annotated = passage.split(/(\s+)/).map(token => {
      if (/^\s+$/.test(token)) return token;
      const clean = token.toLowerCase().replace(/[^a-zàâäéèêëîïôœùûüç']/gi, '');
      const data = wordScores[clean] || wordScores[clean.replace(/'/g, "'")] ;
      if (!data) return `<span class="ann-word ann-neutral">${token}</span>`;
      const s = data.score;
      const cls = data.error === 'Omission' ? 'ann-omission'
                : s >= 85 ? 'ann-good'
                : s >= 65 ? 'ann-ok'
                : 'ann-bad';
      const tooltip = data.error === 'Omission' ? 'Non détecté'
                    : `${Math.round(this.remapScore(s))}%`;
      return `<span class="ann-word ${cls}" title="${tooltip}">${token}<span class="ann-score">${tooltip}</span></span>`;
    }).join('');

    const overlay = document.createElement('div');
    overlay.className = 'annotation-overlay';
    overlay.innerHTML = `
      <div class="ann-legend">
        <span class="ann-good ann-legend-item">● Excellent</span>
        <span class="ann-ok ann-legend-item">● À améliorer</span>
        <span class="ann-bad ann-legend-item">● Difficile</span>
        <span class="ann-omission ann-legend-item">● Non détecté</span>
      </div>
      <div class="ann-text">${annotated}</div>
    `;
    // Replace the plain passage text with annotated version
    const passageDiv = card.querySelector('.passage-text');
    if (passageDiv) card.replaceChild(overlay, passageDiv);
    else card.prepend(overlay);
  },

  renderScores() {
    const allPhonemes = Object.entries(APP_DATA.phonemes);


    const html = APP_DATA.categories.map(cat => {
      const catPhonemes = allPhonemes.filter(([, p]) => p.category === cat.id);
      // Check if this category has any bilan data
      return `
        <div class="scores-category">
          <div class="scores-cat-header" style="color:${cat.accent}">${cat.label}</div>
          <div class="scores-phoneme-list">
            ${catPhonemes.map(([id, p]) => {
              const score = this.getPhonemeScore(id);
              const pct = score !== null ? score : null;
              return `
                <button class="score-phoneme-row" onclick="App.navigate('phoneme',{phonemeId:'${id}'})">
                  <span class="score-ipa" style="color:${cat.accent}">${p.ipa}</span>
                  <span class="score-label">${p.label}</span>
                  <span class="score-bar-wrap">
                    <span class="score-bar" style="width:${pct || 0}%;background:${this.scoreColor(pct || 0)}"></span>
                  </span>
                  <span class="score-pct" style="color:${this.scoreColor(pct || 0)}">${pct !== null ? pct + '%' : '—'}</span>
                </button>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }).join('');

    // Bilan scores are shown in labo-scores screen instead

    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')"><span class="logo-ph">Ph</span><span class="logo-onetique">o</span></button>
        <div class="screen-title">Mes Scores</div>
      </div>
      <div class="scores-container">
        ${html}
      </div>
    `;
  },

  // ── LABO SCORES ──────────────────────────────────────────────
  renderLaboScores() {
    const hasBilan = Object.keys(this.bilanScores).length > 0;

    const bilanHtml = hasBilan ? `
      <div class="bilan-summary-section">
        <div class="bilan-summary-header">
          <span class="bilan-summary-title">🔬 Bilan diagnostic</span>
          <button class="bilan-redo-btn" onclick="App.navigate('bilan')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 0-2.12-9.36L23 10"/></svg>
            Nouveau Bilan
          </button>
        </div>
        <div class="bilan-summary-note">Scores par catégorie · Dernier résultat · Record personnel</div>
        <div class="bilan-cat-list">
          ${APP_DATA.categories.map(cat => {
            const latest = this.bilanScores[cat.id];
            const best   = this.bilanBestScores[cat.id];
            if (latest === undefined) return '';
            return `
              <div class="bilan-cat-row">
                <span class="bilan-cat-name" style="color:${cat.accent}">${cat.icon} ${cat.label}</span>
                <div class="bilan-cat-scores">
                  <span class="bilan-score-latest" style="color:${this.scoreColor(latest)}">${latest}%</span>
                  <span class="bilan-score-sep">·</span>
                  <span class="bilan-score-best" style="color:${this.scoreColor(best)}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:11px;height:11px;vertical-align:middle"><polyline points="18 15 12 9 6 15"/></svg>
                    ${best}%
                  </span>
                </div>
              </div>`;
          }).join('')}
        </div>
      </div>` : `
      <div class="labo-scores-empty">
        <div style="font-size:48px;margin-bottom:12px">🔬</div>
        <p>Aucun Bilan effectué pour l'instant.</p>
        <button class="generate-passage-btn" onclick="App.navigate('bilan')" style="margin-top:8px">
          Faire un Bilan maintenant
        </button>
      </div>`;

    document.getElementById('main').innerHTML = `
      <div class="screen-header" style="border-bottom-color:rgba(0,245,212,0.2)">
        <button class="home-btn" onclick="App.navigate('labo')"><span class="logo-ph" style="color:#00F5D4">Ph</span><span class="logo-onetique" style="color:#2DD4BF">o</span></button>
        <div class="screen-title" style="color:#00F5D4">Scores · Labo</div>
      </div>
      <div class="scores-container">
        ${bilanHtml}
      </div>
    `;
  },

  // ── SETTINGS ────────────────────────────────────────────────
  renderSettings() {
    document.getElementById('main').innerHTML = `
      <div class="screen-header">
        <button class="home-btn" onclick="App.navigate('home')"><span class="logo-ph">Ph</span><span class="logo-onetique">o</span></button>
        <div class="screen-title">Paramètres</div>
      </div>
      <div class="settings-container">

        <div class="settings-group">
          <div class="settings-group-title">Apparence</div>
          <div class="settings-row">
            <div class="settings-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
              Mode sombre
            </div>
            <label class="toggle">
              <input type="checkbox" id="darkModeToggle" ${this.settings.darkMode ? 'checked' : ''} onchange="App.toggleDarkMode(this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="settings-row">
            <div class="settings-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
              Variante française
            </div>
            <select class="settings-select" onchange="App.setFrVariant(this.value)">
              <option value="fr-CA" ${this.settings.frVariant === 'fr-CA' ? 'selected' : ''}>Français canadien</option>
              <option value="fr-FR" ${this.settings.frVariant === 'fr-FR' ? 'selected' : ''}>Français standard</option>
            </select>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-group-title">Intelligence artificielle</div>
          <div class="settings-field">
            <label class="field-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              Clé OpenRouter
            </label>
            <input class="settings-input" type="password" placeholder="sk-or-..." id="orKey" value="${this.settings.openrouterKey}" oninput="App.settings.openrouterKey=this.value;App.saveSettings()">
          </div>
          <div class="settings-field">
            <label class="field-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
              Modèle OpenRouter
            </label>
            <input class="settings-input" type="text" placeholder="openai/gpt-4o-mini" id="orModel" value="${this.settings.openrouterModel}" oninput="App.settings.openrouterModel=this.value;App.saveSettings()">
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-group-title">Azure Pronunciation</div>
          <div class="settings-field">
            <label class="field-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
              Clé Azure Speech
            </label>
            <input class="settings-input" type="password" placeholder="Clé Azure..." id="azKey" value="${this.settings.azureKey}" oninput="App.settings.azureKey=this.value;App.saveSettings()">
          </div>
          <div class="settings-field">
            <label class="field-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
              Région Azure
            </label>
            <input class="settings-input" type="text" placeholder="eastus" id="azRegion" value="${this.settings.azureRegion}" oninput="App.settings.azureRegion=this.value;App.saveSettings()">
          </div>
        </div>

        <button class="reset-scores-btn" onclick="App.confirmResetScores()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>
          Réinitialiser les scores
        </button>
      </div>
    `;
  },

  toggleDarkMode(val) {
    this.settings.darkMode = val;
    this.saveSettings();
    this.applyTheme();
  },
  setFrVariant(val) {
    this.settings.frVariant = val;
    this.saveSettings();
  },
  confirmResetScores() {
    if (confirm('Réinitialiser tous les scores? Cette action est irréversible.')) {
      this.scores = {};
      this.saveScores();
      alert('Scores réinitialisés.');
    }
  },

  // ── TTS ─────────────────────────────────────────────────────
  setupSpeechSynthVoices() {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = () => {};
    }
  },

  speakCurrentPassage() {
    const passages = this.getPassages(this.currentPhoneme);
    const passage = passages[this.currentPassageIndex];
    if (passage) this.speakText(passage.text, false);
  },

  speakCurrentWord() {
    const p = APP_DATA.phonemes[this.currentPhoneme];
    if (!p) return;
    const word = p.practiceWords[this.currentPracticeWordIndex || 0][0];
    this.speakText(word, true);
  },

  goToWord(phonemeId, idx) {
    const p = APP_DATA.phonemes[phonemeId];
    if (!p) return;
    this.currentPracticeWordIndex = idx;
    this._updateCarousel(p);
  },

  nextWord(phonemeId) {
    const p = APP_DATA.phonemes[phonemeId];
    if (!p) return;
    const total = p.practiceWords.length;
    this.currentPracticeWordIndex = (this.currentPracticeWordIndex + 1) % total;
    this._updateCarousel(p, 'next');
  },

  prevWord(phonemeId) {
    const p = APP_DATA.phonemes[phonemeId];
    if (!p) return;
    const total = p.practiceWords.length;
    this.currentPracticeWordIndex = (this.currentPracticeWordIndex - 1 + total) % total;
    this._updateCarousel(p, 'prev');
  },

  _updateCarousel(p, direction) {
    const idx = this.currentPracticeWordIndex;
    const [word, ipa] = p.practiceWords[idx];

    const wrap = document.getElementById('carouselWordWrap');
    const wordEl = document.getElementById('practiceWord');
    const ipaEl = document.getElementById('practiceWordIpa');
    const dots = document.querySelectorAll('.carousel-dot');

    if (wrap) {
      // Slide animation
      const exitClass = direction === 'next' ? 'slide-exit-left' : direction === 'prev' ? 'slide-exit-right' : 'slide-exit-left';
      const enterClass = direction === 'next' ? 'slide-enter-right' : direction === 'prev' ? 'slide-enter-left' : 'slide-enter-right';
      wrap.classList.add(exitClass);
      setTimeout(() => {
        if (wordEl) wordEl.textContent = word;
        if (ipaEl) ipaEl.textContent = ipa;
        wrap.classList.remove(exitClass);
        wrap.classList.add(enterClass);
        setTimeout(() => wrap.classList.remove(enterClass), 300);
      }, 150);
    }

    // Update numbered buttons (both carousel-dot and carousel-num-btn)
    document.querySelectorAll('.carousel-dot, .carousel-num-btn').forEach((d, i) => {
      const isActive = i === idx;
      d.classList.toggle('active', isActive);
      if (d.classList.contains('carousel-num-btn')) {
        const shade = App.getPhonemeShade(App.currentPhoneme);
        d.style.background = isActive ? shade.accent : 'transparent';
        d.style.color = isActive ? '#000' : shade.accent;
        d.style.borderColor = shade.accent;
      }
    });

    // Reset recording state when word changes
    this.retryRecording();
  },

  speakText(text, slow = false) {
    if (!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.lang = this.settings.frVariant;
    utt.rate = slow ? 0.75 : 0.9;
    const voices = window.speechSynthesis.getVoices();
    const frVoice = voices.find(v => v.lang.startsWith(this.settings.frVariant)) ||
                    voices.find(v => v.lang.startsWith('fr'));
    if (frVoice) utt.voice = frVoice;
    window.speechSynthesis.speak(utt);
  },

  // ── RECORDING ────────────────────────────────────────────────
  async toggleRecording(phonemeId, mode, passageIndex = 0) {
    if (this.recording) {
      this.stopRecording(phonemeId, mode, passageIndex);
    } else {
      await this.startRecording(phonemeId, mode, passageIndex);
    }
  },

  async startRecording(phonemeId, mode, passageIndex) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 16000, channelCount: 1 } });
      this.audioChunks = [];
      const mimeType = MediaRecorder.isTypeSupported('audio/wav') ? 'audio/wav'
                      : MediaRecorder.isTypeSupported('audio/webm;codecs=pcm') ? 'audio/webm;codecs=pcm'
                      : 'audio/webm';
      this.mediaRecorder = new MediaRecorder(stream, { mimeType });
      this.recordingMimeType = mimeType;
      this.mediaRecorder.ondataavailable = e => this.audioChunks.push(e.data);
      this.mediaRecorder.onstop = () => {
        this.recordingAudioBlob = new Blob(this.audioChunks, { type: mimeType });
        stream.getTracks().forEach(t => t.stop());
        this.onRecordingDone(phonemeId, mode, passageIndex);
      };
      this.mediaRecorder.start();
      this.recording = true;

      // Azure PA REST API has a 30-second limit. We auto-stop at 29s to prevent hard rejection.
      if (this.recordingTimeout) clearTimeout(this.recordingTimeout);
      this.recordingTimeout = setTimeout(() => {
        if (this.recording) {
          this.stopRecording(phonemeId, mode, passageIndex);
          if (this.showToast) this.showToast('Enregistrement arrêté (limite de 30 secondes atteinte).');
        }
      }, 29000);

      const btn = document.getElementById('recordBtn');
      if (btn) {
        btn.classList.add('recording-active');
        btn.querySelector('.record-label').textContent = 'Enregistrement... (appuyer pour arrêter)';
      }
      const status = document.getElementById('recordingStatus');
      if (status) {
        status.classList.remove('hidden');
        status.innerHTML = `<div class="pulse-dot"></div> En cours...`;
      }
    } catch (err) {
      alert('Impossible d\'accéder au microphone. Veuillez vérifier vos permissions.');
    }
  },

  stopRecording(phonemeId, mode, passageIndex) {
    if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
      this.mediaRecorder.stop();
      this.recording = false;
      const btn = document.getElementById('recordBtn');
      if (btn) {
        btn.classList.remove('recording-active');
        btn.querySelector('.record-label').textContent = 'Analyser...';
        btn.disabled = true;
      }
    }
  },

  async onRecordingDone(phonemeId, mode, passageIndex) {
    const status = document.getElementById('recordingStatus');
    if (status) {
      status.innerHTML = `<div class="analyzing-dots"><span></span><span></span><span></span></div> Analyse en cours...`;
    }

    const playbackArea = document.getElementById('playbackArea');
    if (playbackArea) playbackArea.classList.remove('hidden');

    if (this.settings.azureKey) {
      await this.analyzeWithAzure(phonemeId, mode, passageIndex);
    } else {
      this.showSimpleScore(phonemeId, mode);
    }
  },

  playRecording() {
    if (this.recordingAudioBlob) {
      const url = URL.createObjectURL(this.recordingAudioBlob);
      const audio = new Audio(url);
      audio.play();
    }
  },

  // ── AZURE PRONUNCIATION ASSESSMENT ───────────────────────────
  async analyzeWithAzure(phonemeId, mode, passageIndex) {
    if (mode === 'libre' && !this.phraseLibreText?.trim()) {
      this.showSimpleScore(phonemeId, mode, "Veuillez écrire une phrase avant d'enregistrer.");
      return;
    }
    if (mode === 'bilan' && !this.bilanPassage?.trim()) {
      this.showSimpleScore(phonemeId, mode, "Veuillez d'abord générer un passage.");
      return;
    }
    if (!this.settings.azureKey || !this.settings.azureRegion) {
      this.showSimpleScore(phonemeId, mode, 'Ajoutez une clé Azure dans les paramètres pour obtenir un score.');
      return;
    }
    try {
      const wavBlob = await this.toWav(this.recordingAudioBlob);
      console.log('WAV blob size:', wavBlob.size, 'bytes');

      // Bilan and Read text passages are short enough (<= 50 words) to comfortably 
      // process within the Azure PA 30-second limit without complex frontend chunking.
      return await this._sendToAzure(phonemeId, mode, passageIndex, wavBlob);
    } catch (err) {
      console.error('Azure toWav error:', err);
      this.showSimpleScore(phonemeId, mode, 'Erreur de conversion audio.');
    }
  },

  async _analyzeBilanChunked(wavBlob) {
    const passage = this.bilanPassage || '';

    // Split into chunks of ~2 sentences (max ~12 seconds each).
    // Group by sentence-ending punctuation; avoid splitting on dialogue markers.
    // Strategy: split on '. ' or '! ' or '? ' but NOT inside « » quotes.
    const rawSentences = passage
      .replace(/[«»]/g, '')                       // strip guillemets — keep text
      .split(/(?<=[.!?])\s+(?=[A-ZÀ-Ö])/u)       // split at sentence boundary before capital
      .map(s => s.trim())
      .filter(s => s.length > 5);

    // Group into pairs so each chunk is ~2 sentences (safer for audio windowing)
    const chunks = [];
    for (let i = 0; i < rawSentences.length; i += 2) {
      const pair = rawSentences.slice(i, i + 2).join(' ');
      chunks.push(pair);
    }
    if (chunks.length === 0) chunks.push(passage);

    console.log(`Bilan: ${chunks.length} chunks from ${rawSentences.length} sentences`);

    const statusEl = document.getElementById('recordingStatus');
    if (statusEl) {
      statusEl.classList.remove('hidden');
      statusEl.innerHTML = `<div class="pulse-dot"></div> Analyse en cours (0/${chunks.length})...`;
    }

    // Decode WAV once for slicing
    const arrayBuf = await wavBlob.arrayBuffer();
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
    const decoded  = await audioCtx.decodeAudioData(arrayBuf);
    const sr       = decoded.sampleRate;
    const fullPcm  = decoded.getChannelData(0);
    const totalS   = fullPcm.length / sr;

    const allWords  = [];
    const allScores = [];
    let audioStartSec = 0;
    const WINDOW_S = 25;
    const OVERLAP_S = 1.5;

    for (let i = 0; i < chunks.length; i++) {
      const chunk = chunks[i];
      if (statusEl) statusEl.innerHTML =
        `<div class="pulse-dot"></div> Analyse en cours (${i+1}/${chunks.length})...`;

      // Slice audio window
      const winStart    = Math.max(0, audioStartSec - OVERLAP_S);
      const winEnd      = Math.min(totalS, winStart + WINDOW_S);
      const startSample = Math.floor(winStart * sr);
      const endSample   = Math.floor(winEnd   * sr);
      const slicePcm    = fullPcm.slice(startSample, endSample);
      const slice16     = new Int16Array(slicePcm.length);
      for (let j = 0; j < slicePcm.length; j++) {
        const s = Math.max(-1, Math.min(1, slicePcm[j]));
        slice16[j] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      const chunkBlob = new Blob([this.buildWav(slice16, sr, 1)], { type: 'audio/wav' });

      try {
        const data  = await this._azureRequest(chunkBlob, chunk, true, 'dictation', 35000);
        const nbest = data?.NBest?.[0];

        // Unwrap scores — Azure puts them flat on NBest[0] with detailed format
        const pa = nbest?.PronunciationAssessment
          || (nbest?.AccuracyScore !== undefined ? nbest : null);

        const acc = pa?.AccuracyScore ?? 0;
        const pro = pa?.PronScore ?? acc;
        console.log(`Chunk ${i+1} "${chunk.slice(0,32)}..." → status: ${data?.RecognitionStatus}, words: ${nbest?.Words?.length || 0}, accuracy: ${acc}`);

        if (nbest?.Words?.length) {
          const offsetTicks = Math.round(winStart * 1e7);
          nbest.Words.forEach(w => allWords.push({ ...w, Offset: w.Offset + offsetTicks }));
          if (acc > 0) allScores.push(pro);

          // Advance audio cursor to just after last recognised word
          const lastW = nbest.Words[nbest.Words.length - 1];
          audioStartSec = Math.max(0, (lastW.Offset + lastW.Duration) / 1e7 - 0.3);
        } else {
          // Nothing recognised — step forward by estimated speaking time
          audioStartSec += chunk.split(/\s+/).length * 1.8;
        }
      } catch(e) {
        console.warn(`Chunk ${i} error:`, e);
        audioStartSec += chunk.split(/\s+/).length * 1.8;
      }
    }

    if (statusEl) statusEl.classList.add('hidden');

    if (allWords.length === 0) {
      this.showSimpleScore('__bilan__', 'bilan', 'Aucun mot reconnu — parlez plus lentement et clairement.');
      return;
    }

    // Sort by offset and deduplicate (same offset = same word captured twice)
    allWords.sort((a, b) => a.Offset - b.Offset);
    const deduped = allWords.filter((w, i) =>
      i === 0 || Math.abs(w.Offset - allWords[i-1].Offset) > 100000 // >10ms apart
    );

    const scoredWords = deduped.filter(w => w.AccuracyScore > 0 && w.ErrorType !== 'Omission');
    const overallScore = allScores.length > 0
      ? Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length)
      : scoredWords.length > 0
        ? Math.round(scoredWords.reduce((s, w) => s + w.AccuracyScore, 0) / scoredWords.length)
        : 50;

    const finalScore = Math.round(Math.max(5, Math.min(100, this.remapScore(overallScore))));
    console.log(`Bilan merged: ${deduped.length} words (deduped from ${allWords.length}), raw: ${overallScore}, remapped: ${finalScore}`);

    const fakePA = { AccuracyScore: overallScore, PronScore: overallScore };
    this.showBilanResults(finalScore, fakePA, deduped);
  },

  async _sendToAzure(phonemeId, mode, passageIndex, wavBlob, simpleFallback = false) {
    const p = APP_DATA.phonemes[phonemeId];
    const passages = this.getPassages(phonemeId);

    // Build reference text for this mode
    let referenceText;
    if (mode === 'practice') {
      referenceText = p?.practiceWords?.[App.currentPracticeWordIndex || 0]?.[0] || '';
    } else if (mode === 'libre') {
      referenceText = App.phraseLibreText || '';
    } else if (mode === 'bilan') {
      referenceText = App.bilanPassage || '';
    } else {
      referenceText = passages[passageIndex]?.text || '';
    }

    // On retry for short texts, use just first sentence; for passages keep full text
    if (simpleFallback && mode !== 'read' && mode !== 'bilan') {
      referenceText = referenceText.split(/[.!?]/)[0].trim();
    }

    console.log('→ Azure | mode:', mode, '| fallback:', simpleFallback, '| ref:', referenceText.slice(0, 60) + '...', '| wav bytes:', wavBlob.size);

    // Use dictation mode for long passages, conversation for single words
    const recognitionMode = (mode === 'practice') ? 'conversation' : 'dictation';
    const timeoutMs = (mode === 'bilan' || mode === 'read') ? 90000 : 30000;

    const data = await this._azureRequest(wavBlob, referenceText, !simpleFallback, recognitionMode, timeoutMs);

    if (!data) {
      this.showSimpleScore(phonemeId, mode, 'Erreur réseau ou réponse invalide.');
      return;
    }

    const nbest = data?.NBest?.[0];
    let pa = nbest?.PronunciationAssessment || (nbest?.AccuracyScore !== undefined ? nbest : null);

    // If no top-level pa, synthesise from word-level data
    if (!pa && nbest?.Words?.length > 0) {
      const words = nbest.Words;
      // Azure Granularity:Word nests scores under Words[n].PronunciationAssessment
      const wordPAs = words.map(w => w.PronunciationAssessment || null);
      const hasWordPA = wordPAs.some(p => p !== null && (p.AccuracyScore ?? 0) > 0);

      if (hasWordPA) {
        const scored = wordPAs.filter(p => p && (p.AccuracyScore ?? 0) > 0);
        const avgAcc = scored.reduce((s, p) => s + p.AccuracyScore, 0) / scored.length;
        const completeness = Math.round((wordPAs.filter(p => p).length / words.length) * 100);
        pa = {
          AccuracyScore: Math.round(avgAcc),
          FluencyScore: Math.round(avgAcc * 0.9),
          CompletenessScore: completeness,
          PronScore: Math.round(avgAcc * 0.5 + completeness * 0.5),
        };
        console.log('← Synth from word PAs:', scored.length, '/', words.length, '→ avg:', Math.round(avgAcc), 'PronScore:', pa.PronScore);
      } else {
        // AccuracyScore directly on word (fr-CA format)
        const scored = words.filter(w => (w.AccuracyScore ?? 0) > 0);
        if (scored.length > 0) {
          const avgAcc = scored.reduce((s, w) => s + w.AccuracyScore, 0) / scored.length;
          pa = { AccuracyScore: Math.round(avgAcc), FluencyScore: Math.round(avgAcc * 0.9),
                 CompletenessScore: Math.round((scored.length / words.length) * 100), PronScore: Math.round(avgAcc) };
          console.log('← Synth from direct word AccuracyScore → PronScore:', pa.PronScore);
        }
      }
      console.log('← Word[0] full:', JSON.stringify(words[0]).slice(0, 300));
    }
    console.log('← RecognitionStatus:', data.RecognitionStatus, '| SNR:', data.SNR);
    console.log('← pa:', pa ? JSON.stringify(pa).slice(0, 300) : 'NULL — no scores');

    // Azure heard nothing / silence — only fire when SNR is genuinely zero
    const snr = data.SNR ?? 0;
    if (snr < 2 && (!pa || pa.PronScore === 0)) {
      if (!simpleFallback) {
        return this._sendToAzure(phonemeId, mode, passageIndex, wavBlob, true);
      } else {
        this.showSimpleScore(phonemeId, mode, "Audio non détecté — parlez plus fort et restez proche du micro.");
        return;
      }
    }

    if (pa && pa.AccuracyScore !== undefined) {
      const words = nbest?.Words || [];

      // For long passages (read mode), Azure may only score part of the text.
      // If PronScore=0 but words exist with scores, use word-level average instead.
      let rawScore = pa.PronScore ?? pa.AccuracyScore;
      let fluency  = pa.FluencyScore ?? rawScore;

      if (rawScore === 0 && words.length > 0) {
        const scoredWords = words.filter(w => w.AccuracyScore > 0 && w.ErrorType !== 'Insertion');
        if (scoredWords.length > 0) {
          rawScore = scoredWords.reduce((s, w) => s + w.AccuracyScore, 0) / scoredWords.length;
          fluency  = pa.FluencyScore ?? rawScore;
          console.log('PronScore=0 override: using word avg', rawScore.toFixed(1), 'from', scoredWords.length, 'words');
        }
      }

      if (mode === 'bilan') {
        const finalScore = Math.round(Math.max(5, Math.min(100, this.remapScore(rawScore))));
        this.showBilanResults(finalScore, pa, words);
        return;
      }

      if (mode === 'libre') {
        const finalScore = Math.round(Math.max(5, Math.min(100, this.remapScore(rawScore))));
        this.showAzureScore(finalScore, pa, mode, rawScore, fluency);
        return;
      }

      const ph = APP_DATA.phonemes[phonemeId];
      const isConnectedSpeech = ['liaison', 'rythme'].includes(ph?.category);
      let finalScore;
      if (isConnectedSpeech) {
        const blended = fluency * 0.6 + rawScore * 0.4;
        const timingPenalty = ph?.category === 'liaison' ? this.calcLiaisonPenalty(words) : 0;
        finalScore = this.remapScore(blended) - timingPenalty;
      } else {
        finalScore = this.remapScore(rawScore);
      }
      finalScore = Math.round(Math.max(5, Math.min(100, finalScore)));

      if (mode === 'test') this.recordScore(phonemeId, finalScore);
      if (mode === 'read') this.recordPassageScore(phonemeId, this.currentPassageIndex, finalScore);
      this.showAzureScore(finalScore, pa, mode, rawScore, fluency);

    } else if (data.RecognitionStatus === 'NoMatch' || data.RecognitionStatus === 'InitialSilenceTimeout') {
      this.showSimpleScore(phonemeId, mode, 'Aucune parole détectée — parlez plus fort.');

    } else if (!simpleFallback) {
      return this._sendToAzure(phonemeId, mode, passageIndex, wavBlob, true);

    } else {
      // Last resort: if we have word-level data, use average word accuracy
      const fallbackWords = nbest?.Words?.filter(w => (w.AccuracyScore ?? 0) > 0 && w.ErrorType !== 'Insertion') || [];
      if (fallbackWords.length >= 3) {
        const avgAcc = fallbackWords.reduce((s, w) => s + w.AccuracyScore, 0) / fallbackWords.length;
        const finalScore = Math.round(Math.max(5, Math.min(100, this.remapScore(avgAcc))));
        console.log('Last-resort word avg score:', avgAcc.toFixed(1), '→', finalScore);
        if (mode === 'test') this.recordScore(phonemeId, finalScore);
        if (mode === 'read') this.recordPassageScore(phonemeId, this.currentPassageIndex, finalScore);
        const fakePa = { AccuracyScore: avgAcc, FluencyScore: nbest?.FluencyScore ?? avgAcc, PronScore: avgAcc };
        this.showAzureScore(finalScore, fakePa, mode, avgAcc, fakePa.FluencyScore);
      } else {
        this.showSimpleScore(phonemeId, mode, `Score indisponible. Azure a reconnu : "${nbest?.Display?.slice(0,60) || 'rien'}"`);
      }
    }
  },

  // Convert any recorded Blob → 16-bit PCM WAV at 16 kHz mono
  // using the Web Audio API (works on all modern mobile browsers)
  async toWav(blob) {
    const arrayBuf = await blob.arrayBuffer();
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
    let decoded;
    try {
      decoded = await audioCtx.decodeAudioData(arrayBuf);
    } catch(e) {
      // If decoding fails (e.g. empty blob), return original
      console.warn('Audio decode failed, sending raw:', e);
      audioCtx.close();
      return blob;
    }
    audioCtx.close();

    // Mix down to mono at 16 kHz
    const numChannels = 1;
    const sampleRate = 16000;
    const offlineCtx = new OfflineAudioContext(numChannels, Math.ceil(decoded.duration * sampleRate), sampleRate);
    const src = offlineCtx.createBufferSource();
    src.buffer = decoded;
    src.connect(offlineCtx.destination);
    src.start(0);
    const rendered = await offlineCtx.startRendering();

    // Get PCM samples as Int16, trimming leading silence
    const pcmFloatRaw = rendered.getChannelData(0);
    // Find first sample above noise floor to skip mic warmup silence
    const noiseFloor = 0.002;
    let startIdx = 0;
    for (let i = 0; i < pcmFloatRaw.length; i++) {
      if (Math.abs(pcmFloatRaw[i]) > noiseFloor) { startIdx = Math.max(0, i - 160); break; }
    }
    const pcmFloat = pcmFloatRaw.slice(startIdx);
    const pcm16 = new Int16Array(pcmFloat.length);
    for (let i = 0; i < pcmFloat.length; i++) {
      const s = Math.max(-1, Math.min(1, pcmFloat[i]));
      pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }

    // Build WAV file with header
    const wavBuffer = this.buildWav(pcm16, sampleRate, numChannels);
    return new Blob([wavBuffer], { type: 'audio/wav' });
  },

  buildWav(pcm16, sampleRate, numChannels) {
    const byteRate = sampleRate * numChannels * 2;
    const blockAlign = numChannels * 2;
    const dataSize = pcm16.length * 2;
    const buffer = new ArrayBuffer(44 + dataSize);
    const view = new DataView(buffer);
    const write = (offset, str) => { for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); };
    write(0,  'RIFF');
    view.setUint32(4,  36 + dataSize, true);
    write(8,  'WAVE');
    write(12, 'fmt ');
    view.setUint32(16, 16, true);          // PCM chunk size
    view.setUint16(20, 1,  true);          // PCM format
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, byteRate, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, 16, true);          // 16-bit
    write(36, 'data');
    view.setUint32(40, dataSize, true);
    const samples = new Int16Array(buffer, 44);
    samples.set(pcm16);
    return buffer;
  },

  // Split a PCM Int16Array into chunks of ~maxSeconds each
  splitPcmChunks(pcm16, sampleRate, maxSeconds = 12) {
    const chunkSamples = sampleRate * maxSeconds;
    const chunks = [];
    for (let i = 0; i < pcm16.length; i += chunkSamples) {
      chunks.push(pcm16.slice(i, i + chunkSamples));
    }
    return chunks;
  },

  // Split reference text into ~equal sentence groups matching chunk count
  splitRefTextChunks(text, count) {
    // Split on sentence boundaries
    const sentences = text.match(/[^.!?«»]+[.!?]*/g) || [text];
    if (count <= 1 || sentences.length <= 1) return [text];
    // Distribute sentences across chunks as evenly as possible
    const chunks = [];
    const perChunk = Math.ceil(sentences.length / count);
    for (let i = 0; i < sentences.length; i += perChunk) {
      chunks.push(sentences.slice(i, i + perChunk).join(' ').trim());
    }
    // Pad or trim to exactly count
    while (chunks.length < count) chunks.push(chunks[chunks.length - 1]);
    return chunks.slice(0, count);
  },

  // Send a single WAV blob to Azure and return the parsed response data
  _azureRequest(wavBlob, referenceText, enableMiscue = true, recognitionMode = 'dictation', timeoutMs = 30000) {
    const isFrCA = this.settings.frVariant === 'fr-CA';
    
    const assessmentParams = {
      ReferenceText: referenceText,
      GradingSystem: 'HundredMark',
      Granularity: 'Word',
      Dimension: 'Comprehensive',
      EnableMiscue: isFrCA ? false : enableMiscue,
      ...(isFrCA ? {} : { PhonemeAlphabet: 'IPA' }),
    };
    
    const jsonStr = JSON.stringify(assessmentParams);
    const headerVal = btoa(unescape(encodeURIComponent(jsonStr)));

    // &format=detailed is removed from this URL
    const url = `https://${this.settings.azureRegion}.stt.speech.microsoft.com/speech/recognition/${recognitionMode}/cognitiveservices/v1?language=${this.settings.frVariant}&profanity=raw`;

    return new Promise((resolve) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.timeout = timeoutMs;
      xhr.setRequestHeader('Ocp-Apim-Subscription-Key', this.settings.azureKey);
      xhr.setRequestHeader('Content-Type', 'audio/wav; codecs=audio/pcm; samplerate=16000');
      xhr.setRequestHeader('Pronunciation-Assessment', headerVal);
      xhr.responseType = 'text';
      xhr.onload = () => {
        if (xhr.status !== 200) { console.error('Azure HTTP', xhr.status); resolve(null); return; }
        try { resolve(JSON.parse(xhr.responseText)); }
        catch(e) { console.error('Azure JSON parse error'); resolve(null); }
      };
      xhr.ontimeout = () => { console.error('Azure timeout after', timeoutMs, 'ms'); resolve(null); };
      xhr.onerror  = () => { console.error('Azure XHR error'); resolve(null); };
      xhr.send(wavBlob);
    });
  },

  showAzureScore(score, pa, mode, rawAzure, fluency) {
    const scoreArea = document.getElementById('scoreArea');
    const status = document.getElementById('recordingStatus');
    if (status) status.classList.add('hidden');
    if (!scoreArea) return;
    scoreArea.classList.remove('hidden');
    const color = this.scoreColor(score);
    const feedback = this.scoreFeedback(score);

    // Sub-score pills — show remapped accuracy + fluency if available
    const accRemapped = rawAzure !== undefined ? Math.round(this.remapScore(rawAzure)) : null;
    const fluRemapped = fluency !== undefined ? Math.round(this.remapScore(fluency)) : null;
    const subScores = (accRemapped !== null && fluRemapped !== null && accRemapped !== score)
      ? `<div class="score-sub-row">
           <div class="score-sub"><span class="score-sub-label">Précision</span><span class="score-sub-val" style="color:${this.scoreColor(accRemapped)}">${accRemapped}%</span></div>
           <div class="score-sub"><span class="score-sub-label">Fluidité</span><span class="score-sub-val" style="color:${this.scoreColor(fluRemapped)}">${fluRemapped}%</span></div>
         </div>`
      : (pa?.FluencyScore ? `<div class="score-detail">Fluidité : ${fluRemapped ?? Math.round(pa.FluencyScore)}%</div>` : '');

    scoreArea.innerHTML = `
      <div class="score-display">
        <div class="score-ring" style="--score-color:${color};--score-pct:${score}">
          <svg viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
            <circle cx="50" cy="50" r="40" fill="none" stroke="${color}" stroke-width="8"
              stroke-dasharray="${2.51 * score} 251" stroke-linecap="round" transform="rotate(-90 50 50)"/>
          </svg>
          <div class="score-number">${score}<span class="score-pct-sym">%</span></div>
        </div>
        <div class="score-feedback">${feedback}</div>
        ${subScores}
        ${mode === 'read' ? `<div class="score-next-hint">${score >= 60 ? '✓ Prêt pour le prochain passage!' : 'Continuez à pratiquer!'}</div>` : ''}
      </div>
      <button class="retry-btn" onclick="App.retryRecording()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>
        Réessayer
      </button>
      ${mode === 'read' && score >= 60 ? `<button class="next-btn" onclick="App.nextPassage()">Passage suivant →</button>` : ''}
    `;
    const btn = document.getElementById('recordBtn');
    if (btn) {
      btn.disabled = false;
      btn.querySelector('.record-label').textContent = 'Enregistrer à nouveau';
    }
    // For read mode: inject a purple "Record" ring next to the main score ring
    if (mode === 'read') {
      document.querySelectorAll('.passage-best-score').forEach(el => el.remove());
      const best = this.getPassageScore(this.currentPhoneme, this.currentPassageIndex);
      if (best !== null) {
        const scoreDisplay = scoreArea.querySelector('.score-display');
        if (scoreDisplay) {
          const dash = Math.round(2.51 * best);
          const wrap = document.createElement('div');
          wrap.className = 'record-ring-wrap';
          wrap.innerHTML =
            '<div class="score-ring-label">Record</div>' +
            '<div class="score-ring" style="--score-color:#A78BFA;--score-pct:' + best + '">' +
              '<svg viewBox="0 0 100 100">' +
                '<circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>' +
                '<circle cx="50" cy="50" r="40" fill="none" stroke="#A78BFA" stroke-width="8"' +
                  ' stroke-dasharray="' + dash + ' 251" stroke-linecap="round" transform="rotate(-90 50 50)"/>' +
              '</svg>' +
              '<div class="score-number" style="font-size:18px">' + best + '<span class="score-pct-sym">%</span></div>' +
            '</div>';
          scoreDisplay.appendChild(wrap);
        }
      }
    }
  },

  showSimpleScore(phonemeId, mode, customMsg) {
    const scoreArea = document.getElementById('scoreArea');
    const status = document.getElementById('recordingStatus');
    if (status) status.classList.add('hidden');
    if (!scoreArea) return;
    scoreArea.classList.remove('hidden');
    scoreArea.innerHTML = `
      <div class="no-azure-msg">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        ${customMsg || 'Ajoutez une clé Azure dans les paramètres pour obtenir un score de prononciation.'}
      </div>
      <button class="retry-btn" onclick="App.retryRecording()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>
        Réessayer
      </button>
    `;
    const btn = document.getElementById('recordBtn');
    if (btn) {
      btn.disabled = false;
      btn.querySelector('.record-label').textContent = 'Enregistrer à nouveau';
    }
  },

  retryRecording() {
    const scoreArea = document.getElementById('scoreArea');
    const playbackArea = document.getElementById('playbackArea');
    const status = document.getElementById('recordingStatus');
    if (scoreArea) scoreArea.classList.add('hidden');
    if (playbackArea) playbackArea.classList.add('hidden');
    if (status) { status.classList.add('hidden'); status.innerHTML = ''; }
    const btn = document.getElementById('recordBtn');
    if (btn) {
      btn.disabled = false;
      btn.querySelector('.record-label').textContent = 'Appuyer pour enregistrer';
    }
  },

  nextPassage() {
    const nextIdx = this.currentPassageIndex + 1;
    const passages = this.getPassages(this.currentPhoneme);
    if (nextIdx < passages.length) {
      this.navigate('mode-read', { phonemeId: this.currentPhoneme, passageIndex: nextIdx });
    } else {
      this.navigate('phoneme', { phonemeId: this.currentPhoneme });
    }
  },

  // ── OPENROUTER PASSAGE GENERATION ────────────────────────────
  async generateNewPassage(phonemeId, slotIndex) {
    const p = APP_DATA.phonemes[phonemeId];
    const btn = document.querySelector('.generate-btn');
    if (btn) btn.disabled = true;

    // Difficulty levels 0-9 mapped to passage slots 0-9
    const difficultyInstructions = [
      // Slot 0 (passage 1) — 1 sentence only, very simple
      "1 seule phrase courte (12-16 mots maximum) avec 1-2 exemples du son. Vocabulaire de base uniquement.",
      // Slot 1 (passage 2) — 2 short sentences
      "2 phrases très courtes (20-28 mots au total) avec 2-3 exemples du son. Vocabulaire simple et courant.",
      // Slots 2-9 — all same standard length as existing passages
      "3-4 phrases (45-60 mots) avec 4-6 exemples du son. Vocabulaire varié, phrases naturelles.",
      "3-4 phrases (45-60 mots) avec 4-6 exemples du son. Vocabulaire varié, phrases naturelles.",
      "3-4 phrases (45-60 mots) avec 4-6 exemples du son. Vocabulaire varié, phrases naturelles.",
      "3-4 phrases (45-60 mots) avec 4-6 exemples du son. Vocabulaire varié, style légèrement plus soutenu.",
      "3-4 phrases (45-60 mots) avec 4-6 exemples du son. Vocabulaire riche, registre formel ou littéraire.",
      "3-4 phrases (45-60 mots) avec 4-6 exemples du son. Style journalistique ou narratif soutenu.",
      "3-4 phrases (45-60 mots) avec 4-6 exemples du son. Expressions idiomatiques bienvenues.",
      "3-4 phrases (45-60 mots) avec 4-6 exemples du son. Niveau natif : diversité lexicale maximale.",
    ];
    const diffLevel = Math.min(slotIndex, difficultyInstructions.length - 1);
    const diffInstruction = difficultyInstructions[diffLevel];

    const prompt = "Écris un passage en français sur le son " + p.ipa + " (" + p.label + "). Graphies cibles : " + p.graphies.join(', ') + ". Consignes de difficulté : " + diffInstruction + " Le texte doit être cohérent et naturel, ne PAS répéter les mots clés du passage précédent. IMPORTANT: Réponds avec UNIQUEMENT du texte brut, sans astérisques ni formatage markdown.";

    try {
      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.settings.openrouterKey}`,
          'Content-Type': 'application/json',
          'HTTP-Referer': window.location.href,
        },
        body: JSON.stringify({
          model: this.settings.openrouterModel,
          messages: [{ role: 'user', content: prompt }],
          max_tokens: 200,
        }),
      });

      const data = await response.json();
      const newText = data.choices?.[0]?.message?.content?.trim();
      if (newText) {
        const passageText = document.getElementById('passageText');
        if (passageText) {
          passageText.innerHTML = this.highlightPassage(newText, phonemeId);
          if (!this.generatedPassages[phonemeId]) this.generatedPassages[phonemeId] = {};
          this.generatedPassages[phonemeId][slotIndex] = newText;
        }
      }
    } catch (err) {
      console.error('OpenRouter error:', err);
    }
    if (btn) btn.disabled = false;
  },

  // ── HELPERS ──────────────────────────────────────────────────
  getPassages(phonemeId) {
    return APP_DATA.phonemes[phonemeId]?.passages || [];
  },

  highlightPassage(text, phonemeId) {
    const p = APP_DATA.phonemes[phonemeId];
    if (!p) return text;

    // Special liaison highlighting
    if (p.category === 'liaison') {
      return this.highlightLiaison(text, phonemeId);
    }

    // Context-aware graphie highlighting.
    // Problem: naive substring matching hits false positives like
    // 'um' in 'costume' (which is /y/, not /œ̃/) or 'in' in 'inviter'.
    // Solution: for each graphie, we apply a phonetic position rule
    // based on where that graphie actually produces the target sound.
    const GRAPHIE_RULES = {
      // Nasal vowels — graphie is nasal only before consonant or at end of word
      // NOT before a vowel (which would denasalise it), NOT doubled
      'an': /(?<![aeo])an(?![aeiouéèêëàâùûîïôœh])/gi,
      'en': /(?<![aeo])en(?![aeiouéèêëàâùûîïôœh])/gi,
      'am': /am(?![aeiouéèêëàâùûîïôœh])/gi,
      'em': /em(?![aeiouéèêëàâùûîïôœh])/gi,
      'in': /(?<![aeo])in(?![aeiouéèêëàâùûîïôœh])/gi,
      'im': /im(?![aeiouéèêëàâùûîïôœh])/gi,
      'ain': /ain(?![aeiouéèêëàâùûîïôœh])/gi,
      'ein': /ein(?![aeiouéèêëàâùûîïôœh])/gi,
      'on': /(?<![aeo])on(?![aeiouéèêëàâùûîïôœh])/gi,
      'om': /om(?![aeiouéèêëàâùûîïôœh])/gi,
      // 'un'/'um' nasal — only at word-end or before consonant, NOT in middle of word after vowel
      'un': /un(?=[^aeiouéèêëàâùûîïôœh\s]|)/gi,
      'um': /um(?=[^aeiouéèêëàâùûîïôœh]|)/gi,
      // Rounded vowels — these are mostly unambiguous in position
      'u':  /(?<=[bcdfghjklmnpqrstvwxyz])u(?=[^aeiouéèêëàâùûîïôœ]|$|\s)/gi,
      'eu': /eu(?!x)/gi,
      'eux': /eux/gi,
      'oe': /oe/gi,
      'œ': /œ/gi,
      // é è ê sounds
      'é': /é/gi,
      'er': /er/gi,   // only at word end
      'ez': /ez/gi,
      'ée': /ée/gi,
      'è': /è/gi,
      'ê': /ê/gi,
      'ai': /ai/gi,
      'ei': /ei/gi,
      // o sounds — 'o' is common and mostly unambiguous
      'o': /o\B|\Bo/gi,
      'au': /au/gi,
      'eau': /eau/gi,
      'ô': /ô/gi,
      'î': /î/gi,
      'â': /â/gi,
      'à': /à/gi,
      'ù': /ù/gi,
      'û': /û/gi,
      'ç': /ç/gi,
      // Consonnes — full graphie is fairly unambiguous
      'gn': /gn/gi,
      'ill': /ill/gi,
      'il': /il/gi,
      'ille': /ille/gi,
      'ail': /ail/gi,
      'eil': /eil/gi,
      'euil': /euil/gi,
      'r': null, // 'r' alone is too common — skip, rely on context in passage
      // Terminaisons — only at word end
      'ent': /ent/gi,
      'er': /er/gi,
      'ez': /ez/gi,
      'tion': /tion/gi,
      // Liaison consonants — handled by highlightLiaison
    };

    // Allow 1-char graphies only if they're accented/special French chars (unambiguous)
    const SAFE_SINGLE = new Set(['é','è','ê','ë','à','â','ô','î','ï','û','ù','œ','æ','ç','ñ']);
    const graphies = p.graphies.filter(g => g.length >= 2 || SAFE_SINGLE.has(g));
    if (graphies.length === 0) return text;

    let result = text;
    // Apply each graphie's specific pattern, or fall back to word-boundary match
    graphies.forEach(g => {
      const rule = GRAPHIE_RULES[g.toLowerCase()];
      let pattern;
      if (rule) {
        pattern = rule;
        // Reset lastIndex in case flag is /g
        pattern.lastIndex = 0;
      } else if (g.length >= 3) {
        // For longer graphies (3+ chars), simple match is usually safe
        const esc = g.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        pattern = new RegExp('(' + esc + ')', 'gi');
      } else {
        return; // skip short ambiguous graphies without a rule
      }
      if (rule) {
        // GRAPHIE_RULES patterns have no capture group → use $& (full match)
        result = result.replace(pattern, '<mark>$&</mark>');
      } else {
        // Fallback patterns have a capture group → use $1
        result = result.replace(pattern, '<mark>$1</mark>');
      }
    });
    return result;
  },

  highlightLiaison(text, phonemeId) {
    // Colour the linking consonant orange, the vowel it links to in blue
    // Pattern: word-final s/z/n/t/d/r/x at end of a word, followed by space, then vowel-initial word
    const result = text.replace(/\b([szntdrx])(\s+)([aâàáeéèêëiîïoôœùûu])/gi,
      (m, cons, sp, vowel) => '<span class="liaison-cons">' + cons + '</span>' + sp + '<span class="liaison-vowel">' + vowel + '</span>'
    );
    return result;
  },

  getPhonemeScore(phonemeId) {
    const scores = this.scores[phonemeId];
    if (!scores || scores.length === 0) return null;
    return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
  },

  recordScore(phonemeId, score) {
    if (!this.scores[phonemeId]) this.scores[phonemeId] = [];
    this.scores[phonemeId].push(score);
    // Keep last 10 scores
    if (this.scores[phonemeId].length > 10) this.scores[phonemeId].shift();
    this.saveScores();
  },

  getPhonemeShade(phonemeId) {
    const p = APP_DATA.phonemes[phonemeId];
    if (this.phonemeShades[phonemeId]) return this.phonemeShades[phonemeId];
    // Not cached yet — generate all shades for this category now
    const cat = APP_DATA.categories.find(c => c.id === p.category);
    const catPhonemes = cat.phonemes;
    const shades = this.generatePhonemeShades(cat.color, cat.accent, catPhonemes.length);
    catPhonemes.forEach((id, i) => { this.phonemeShades[id] = shades[i]; });
    return this.phonemeShades[phonemeId] || { color: cat.color, accent: cat.accent };
  },

  generatePhonemeShades(baseColor, baseAccent, count) {
    // Parse the base hex colour and generate 'count' visually distinct but related shades
    // We shift hue slightly and vary lightness/saturation for each phoneme
    function hexToHsl(hex) {
      let r = parseInt(hex.slice(1,3),16)/255;
      let g = parseInt(hex.slice(3,5),16)/255;
      let b = parseInt(hex.slice(5,7),16)/255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      let h, s, l = (max+min)/2;
      if (max===min) { h=s=0; }
      else {
        const d = max-min;
        s = l>0.5 ? d/(2-max-min) : d/(max+min);
        switch(max) {
          case r: h=((g-b)/d+(g<b?6:0))/6; break;
          case g: h=((b-r)/d+2)/6; break;
          case b: h=((r-g)/d+4)/6; break;
        }
      }
      return [h*360, s*100, l*100];
    }
    function hslToHex(h, s, l) {
      h/=360; s/=100; l/=100;
      let r,g,b;
      if(s===0){r=g=b=l;}
      else {
        const q=l<0.5?l*(1+s):l+s-l*s, p=2*l-q;
        const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};
        r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);
      }
      return '#'+[r,g,b].map(x=>Math.round(x*255).toString(16).padStart(2,'0')).join('');
    }
    const [h, s, l] = hexToHsl(baseColor);
    const [ah, as_, al] = hexToHsl(baseAccent);
    // Shift hue by up to ±40deg across the set, vary lightness slightly
    const shades = [];
    for (let i = 0; i < count; i++) {
      const t = count === 1 ? 0 : i / (count - 1);
      const hueShift = (t - 0.5) * 60; // -30 to +30 degrees
      const lightShift = (t - 0.5) * 12; // slight lightness variation
      const color = hslToHex((h + hueShift + 360) % 360, Math.min(100, s + 5), Math.min(70, Math.max(15, l + lightShift)));
      const accent = hslToHex((ah + hueShift + 360) % 360, Math.min(100, as_), Math.min(90, Math.max(40, al + lightShift * 1.5)));
      shades.push({ color, accent });
    }
    return shades;
  },

  // ── SCORE REMAPPING ─────────────────────────────────────────
  // Azure clusters real-world scores between ~55 (barely intelligible)
  // and ~95 (near-native). We remap that range to a more discriminating
  // 0-100 scale using a smooth curve so differences feel meaningful.
  //
  //  Azure  →  Our score
  //   95+   →  100  (native)
  //   88    →  75   (good, light accent)
  //   80    →  55   (noticeable accent)
  //   70    →  32   (strong accent — like an Anglo R)
  //   60    →  18   (barely recognizable)
  //   ≤50   →  8    (floor — something was said)
  remapScore(azureScore) {
    // Clamp input
    const s = Math.max(0, Math.min(100, azureScore));
    // Control points: [azure, ours]
    const pts = [[0,0],[50,12],[60,25],[70,42],[78,57],[85,72],[90,85],[95,94],[100,100]];
    // Find surrounding segment and lerp
    for (let i = 1; i < pts.length; i++) {
      const [ax, ay] = pts[i-1];
      const [bx, by] = pts[i];
      if (s <= bx) {
        const t = (s - ax) / (bx - ax);
        // Ease-in-out within segment
        const e = t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
        return ay + e * (by - ay);
      }
    }
    return 100;
  },

  // ── LIAISON TIMING PENALTY ──────────────────────────────────
  // Azure gives us word-level timing offsets (in 100ns ticks).
  // A native liaison creates a very short gap (<30ms) between
  // specific word pairs. We check known liaison pairs and penalize
  // gaps that are suspiciously long (>120ms = liaison likely skipped).
  calcLiaisonPenalty(words) {
    if (!words || words.length < 2) return 0;
    // Words that should trigger liaison when followed by a vowel-initial word
    const liaisonTriggers = /^(les|des|ces|mes|tes|ses|nos|vos|leurs|ils|elles|nous|vous|on|un|en|mon|ton|son|bien|très|fort|grand|petit|premier|dernier|tout|aux|quand)$/i;
    const vowelStart = /^[aâàeéèêëiîïoôœùûuhy]/i;

    let totalPenalty = 0;
    let liaisonOpportunities = 0;

    for (let i = 0; i < words.length - 1; i++) {
      const w1 = words[i];
      const w2 = words[i+1];
      if (!w1.Word || !w2.Word) continue;
      if (!liaisonTriggers.test(w1.Word)) continue;
      if (!vowelStart.test(w2.Word)) continue;

      liaisonOpportunities++;
      // Gap in 100ns ticks → ms
      const w1End = (w1.Offset + w1.Duration) / 10000;
      const w2Start = w2.Offset / 10000;
      const gapMs = w2Start - w1End;

      console.log(`Liaison check: "${w1.Word}" → "${w2.Word}" gap: ${gapMs.toFixed(0)}ms`);

      // Native liaison: gap < 40ms. Missed liaison: gap > 120ms.
      if (gapMs > 180) totalPenalty += 14;       // clearly skipped
      else if (gapMs > 120) totalPenalty += 8;   // probably skipped
      else if (gapMs > 60)  totalPenalty += 3;   // borderline
      // < 60ms = good, no penalty
    }

    if (liaisonOpportunities === 0) return 0;
    // Scale penalty by how many opportunities existed (don't over-penalize short passages)
    const scaledPenalty = totalPenalty * Math.min(1, 3 / liaisonOpportunities);
    console.log(`Liaison: ${liaisonOpportunities} opportunities, penalty: ${scaledPenalty.toFixed(1)} pts`);
    return Math.min(35, scaledPenalty); // cap at -35 pts
  },

  scoreColor(score) {
    if (score === null || score === 0) return '#6B7280';
    if (score >= 78) return '#34D399';
    if (score >= 55) return '#60A5FA';
    if (score >= 35) return '#FBBF24';
    return '#F87171';
  },

  scoreFeedback(score) {
    if (score >= 90) return 'Excellent! Prononciation native! 🎉';
    if (score >= 78) return 'Très bien! Accent très léger. ✨';
    if (score >= 62) return 'Bien! Accent perceptible mais clair.';
    if (score >= 45) return 'Accent notable — continuez à pratiquer!';
    if (score >= 28) return 'Accent fort — ce son a besoin de travail.';
    return 'Recommencez — rapprochez-vous du son cible!';
  },
};

  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => App.init());
  </script>
</body>
</html>
